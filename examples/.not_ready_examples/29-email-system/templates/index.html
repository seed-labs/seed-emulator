{% extends "base.html" %}

{% block content %}
<!-- ç³»ç»ŸçŠ¶æ€æ¦‚è§ˆ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-8">
                        <h4 class="card-title mb-0">
                            <i class="fas fa-server"></i> SEED é‚®ä»¶ç³»ç»ŸçŠ¶æ€æ¦‚è§ˆ
                        </h4>
                        <p class="card-text mb-0">29-email-system æµ‹è¯•ç½‘ç»œç¯å¢ƒ</p>
                    </div>
                    <div class="col-4 text-end">
                        <h2 class="mb-0">{{ system_info.running_containers }}/{{ system_info.total_containers }}</h2>
                        <small>å®¹å™¨è¿è¡Œä¸­</small>
                    
                    <div class="col-md-4">
                        <div class="card border-info">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0">ğŸ“§ Roundcube Webmail</h6>
                            </div>
                            <div class="card-body">
                                <p class="card-text">å®Œæ•´çš„Webé‚®ä»¶å®¢æˆ·ç«¯</p>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-info" onclick="startRoundcube()">å¯åŠ¨ Roundcube</button>
                                    <a href="http://localhost:8080/webmail/" target="_blank" class="btn btn-outline-info">
                                        è®¿é—® Webmail
                                    </a>
                                    <button class="btn btn-outline-secondary" onclick="stopRoundcube()">åœæ­¢æœåŠ¡</button>
                                </div>
                            </div>
                        </div>
                    </div></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ç»Ÿè®¡å¡ç‰‡ -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center border-success">
            <div class="card-body">
                <i class="fas fa-envelope fa-2x text-success mb-2"></i>
                <h5 class="card-title">{{ system_info.mail_servers }}</h5>
                <p class="card-text">é‚®ä»¶æœåŠ¡å™¨</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-primary">
            <div class="card-body">
                <i class="fas fa-network-wired fa-2x text-primary mb-2"></i>
                <h5 class="card-title">{{ system_info.total_containers }}</h5>
                <p class="card-text">ç½‘ç»œèŠ‚ç‚¹</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-warning">
            <div class="card-body">
                <i class="fas fa-globe fa-2x text-warning mb-2"></i>
                <h5 class="card-title">3</h5>
                <p class="card-text">é‚®ä»¶åŸŸå</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-info">
            <div class="card-body">
                <i class="fas fa-clock fa-2x text-info mb-2"></i>
                <h5 class="card-title">{{ system_info.timestamp.split(' ')[1][:5] }}</h5>
                <p class="card-text">æœ€åæ›´æ–°</p>
            </div>
        </div>
    </div>
</div>

<!-- é‚®ä»¶æœåŠ¡å™¨åˆ—è¡¨ -->
<div class="row">
    <div class="col-12">
        <h3 class="mb-3"><i class="fas fa-mail-bulk"></i> é‚®ä»¶æœåŠ¡å™¨ç®¡ç†</h3>
    </div>
</div>

<div class="row">
    {% for server in mail_servers %}
    <div class="col-md-4 mb-4">
        <div class="card server-card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-envelope-square"></i> {{ server.domain }}
                </h5>
                {% set container_info = containers|selectattr('Name', 'contains', server.container)|first %}
                {% if container_info %}
                    {% if container_info.State == 'running' %}
                        <span class="badge bg-success">è¿è¡Œä¸­</span>
                    {% else %}
                        <span class="badge bg-danger">å·²åœæ­¢</span>
                    {% endif %}
                {% else %}
                    <span class="badge bg-secondary">æœªçŸ¥</span>
                {% endif %}
            </div>
            <div class="card-body">
                <div class="row mb-2">
                    <div class="col-6">
                        <small class="text-muted">ASå·ç </small>
                        <div class="fw-bold">AS-{{ server.as_number }}</div>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">å†…ç½‘IP</small>
                        <div class="fw-bold">{{ server.internal_ip }}</div>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-6">
                        <small class="text-muted">SMTPç«¯å£</small>
                        <div class="fw-bold">:{{ server.smtp_port }}</div>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">IMAPç«¯å£</small>
                        <div class="fw-bold">:{{ server.imap_port }}</div>
                    </div>
                </div>

                <div class="d-grid gap-2">
                    <a href="{{ url_for('server_detail', server_name=server.name) }}" 
                       class="btn btn-seed btn-sm">
                        <i class="fas fa-cog"></i> ç®¡ç†æœåŠ¡å™¨
                    </a>
                    <button class="btn btn-outline-primary btn-sm" 
                            onclick="testServerConnection('{{ server.internal_ip }}', '{{ server.name }}')">
                        <i class="fas fa-wifi"></i> æµ‹è¯•è¿æ¥
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- å¿«é€Ÿæ“ä½œåŒºåŸŸ -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-tools"></i> å¿«é€Ÿæ“ä½œ</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>åˆ›å»ºé‚®ä»¶è´¦æˆ·</h6>
                        <form id="createAccountForm">
                            <div class="row g-2">
                                <div class="col-5">
                                    <input type="text" class="form-control" id="newEmail" 
                                           placeholder="username" required>
                                </div>
                                <div class="col-1 text-center">@</div>
                                <div class="col-4">
                                    <select class="form-select" id="emailDomain" required>
                                        {% for server in mail_servers %}
                                        <option value="{{ server.domain }}">{{ server.domain }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-12 mt-2">
                                    <input type="password" class="form-control" id="newPassword" 
                                           placeholder="å¯†ç " required>
                                </div>
                                <div class="col-12 mt-2">
                                    <button type="submit" class="btn btn-success btn-sm">
                                        <i class="fas fa-user-plus"></i> åˆ›å»ºè´¦æˆ·
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <div class="col-md-6">
                        <h6>å‘é€æµ‹è¯•é‚®ä»¶</h6>
                        <form id="sendEmailForm">
                            <div class="row g-2">
                                <div class="col-6">
                                    <input type="email" class="form-control" id="fromEmail" 
                                           placeholder="å‘ä»¶äººé‚®ç®±" required>
                                </div>
                                <div class="col-6">
                                    <input type="email" class="form-control" id="toEmail" 
                                           placeholder="æ”¶ä»¶äººé‚®ç®±" required>
                                </div>
                                <div class="col-12 mt-2">
                                    <input type="text" class="form-control" id="emailSubject" 
                                           placeholder="é‚®ä»¶ä¸»é¢˜" value="SEEDæµ‹è¯•é‚®ä»¶">
                                </div>
                                <div class="col-12 mt-2">
                                    <button type="submit" class="btn btn-primary btn-sm">
                                        <i class="fas fa-paper-plane"></i> å‘é€æµ‹è¯•é‚®ä»¶
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ç³»ç»Ÿä¿¡æ¯ -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-info-circle"></i> ç³»ç»Ÿä¿¡æ¯</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>ç½‘ç»œæ¶æ„</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-exchange-alt text-primary"></i> 1ä¸ªInternet Exchange (IX-100)</li>
                            <li><i class="fas fa-building text-success"></i> 1ä¸ªTransit AS (AS-2)</li>
                            <li><i class="fas fa-envelope text-warning"></i> 3ä¸ªé‚®ä»¶æä¾›å•† (AS-150/151/152)</li>
                            <li><i class="fas fa-users text-info"></i> 2ä¸ªå®¢æˆ·ç½‘ç»œ (AS-160/161)</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>æŠ€æœ¯æ ˆ</h6>
                        <ul class="list-unstyled">
                            <li><i class="fab fa-docker text-primary"></i> Docker + docker-compose</li>
                            <li><i class="fas fa-network-wired text-success"></i> SEED Emulator Framework</li>
                            <li><i class="fas fa-envelope text-warning"></i> docker-mailserver</li>
                            <li><i class="fas fa-route text-info"></i> BGP/OSPFè·¯ç”±åè®®</li>
                        </ul>
                    </div>
                </div>
                
                <hr>
                
                <div class="row">
                    <div class="col-md-12">
                        <h6>å¤–éƒ¨è®¿é—®ç«¯å£</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>æœåŠ¡å™¨</th>
                                        <th>SMTP</th>
                                        <th>IMAP</th>
                                        <th>æµ‹è¯•å‘½ä»¤</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for server in mail_servers %}
                                    <tr>
                                        <td>{{ server.domain }}</td>
                                        <td><code>localhost:{{ server.smtp_port }}</code></td>
                                        <td><code>localhost:{{ server.imap_port }}</code></td>
                                        <td><code>nc localhost {{ server.smtp_port }}</code></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// æµ‹è¯•æœåŠ¡å™¨è¿æ¥
function testServerConnection(ip, name) {
    fetch('/test_connectivity', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ target: ip })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(`${name} (${ip}) è¿æ¥æµ‹è¯•æˆåŠŸ!`, 'success');
        } else {
            showAlert(`${name} (${ip}) è¿æ¥æµ‹è¯•å¤±è´¥: ${data.error}`, 'danger');
        }
    })
    .catch(error => {
        showAlert('è¿æ¥æµ‹è¯•è¯·æ±‚å¤±è´¥', 'danger');
    });
}

// åˆ›å»ºè´¦æˆ·è¡¨å•å¤„ç†
document.getElementById('createAccountForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const username = document.getElementById('newEmail').value;
    const domain = document.getElementById('emailDomain').value;
    const password = document.getElementById('newPassword').value;
    const email = username + '@' + domain;
    
    fetch('/create_account', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: email, password: password })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            this.reset();
        } else {
            showAlert(data.message, 'danger');
        }
    })
    .catch(error => {
        showAlert('è´¦æˆ·åˆ›å»ºè¯·æ±‚å¤±è´¥', 'danger');
    });
});

// å‘é€é‚®ä»¶è¡¨å•å¤„ç†
document.getElementById('sendEmailForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const fromEmail = document.getElementById('fromEmail').value;
    const toEmail = document.getElementById('toEmail').value;
    const subject = document.getElementById('emailSubject').value;
    
    fetch('/send_test_email', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
            from_email: fromEmail, 
            to_email: toEmail, 
            subject: subject,
            body: 'è¿™æ˜¯æ¥è‡ªSEEDé‚®ä»¶ç³»ç»Ÿ29æµ‹è¯•ç½‘ç»œçš„æµ‹è¯•é‚®ä»¶ã€‚\n\nå‘é€æ—¶é—´: ' + new Date().toLocaleString()
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
        } else {
            showAlert(data.message, 'danger');
        }
    })
    .catch(error => {
        showAlert('é‚®ä»¶å‘é€è¯·æ±‚å¤±è´¥', 'danger');
    });
});

    
    // Roundcubeæ§åˆ¶å‡½æ•°
    function startRoundcube() {
        fetch('/start_roundcube', {method: 'POST'})
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(data.message, 'success');
                setTimeout(() => {
                    window.open('http://localhost:8080/webmail/', '_blank');
                }, 2000);
            } else {
                showAlert(data.message, 'danger');
            }
        })
        .catch(error => showAlert('è¯·æ±‚å¤±è´¥: ' + error, 'danger'));
    }
    
    function stopRoundcube() {
        if (confirm('ç¡®å®šè¦åœæ­¢RoundcubeæœåŠ¡å—ï¼Ÿ')) {
            fetch('/stop_roundcube', {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                showAlert(data.message, data.success ? 'success' : 'danger');
            })
            .catch(error => showAlert('è¯·æ±‚å¤±è´¥: ' + error, 'danger'));
        }
    }</script>
{% endblock %}
