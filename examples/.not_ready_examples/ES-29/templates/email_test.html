{% extends "base.html" %}

{% block title %}é‚®ä»¶å‘ä¿¡æµ‹è¯• - SEEDé‚®ä»¶ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-gradient-primary text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-envelope fa-3x me-3"></i>
                        <div>
                            <h1 class="h2 mb-1">ğŸ“§ é‚®ä»¶å‘ä¿¡æµ‹è¯•</h1>
                            <p class="mb-0">åœ¨å‘é€é‚®ä»¶å‰éªŒè¯ç”¨æˆ·è´¦æˆ·ï¼Œæ‰§è¡ŒçœŸå®çš„é‚®ä»¶å‘é€æµ‹è¯•</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç”¨æˆ·éªŒè¯éƒ¨åˆ† -->
    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-user-check me-2"></i>ç”¨æˆ·è´¦æˆ·éªŒè¯</h5>
                </div>
                <div class="card-body">
                    <form id="userCheckForm">
                        <div class="mb-3">
                            <label for="emailInput" class="form-label">é‚®ç®±åœ°å€</label>
                            <input type="email" class="form-control" id="emailInput"
                                   placeholder="ä¾‹å¦‚: user@seedemail.net" required>
                        </div>
                        <div class="mb-3">
                            <label for="serverSelect" class="form-label">é‚®ä»¶æœåŠ¡å™¨</label>
                            <select class="form-select" id="serverSelect" required>
                                <option value="">é€‰æ‹©é‚®ä»¶æœåŠ¡å™¨</option>
                                {% for server in mail_servers %}
                                <option value="{{ server.id }}">{{ server.name }} ({{ server.domain }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary" id="checkUserBtn">
                            <i class="fas fa-search me-2"></i>éªŒè¯ç”¨æˆ·
                        </button>
                    </form>

                    <!-- éªŒè¯ç»“æœ -->
                    <div id="userCheckResult" class="mt-3" style="display: none;">
                        <div class="alert" role="alert">
                            <div class="d-flex">
                                <div id="userCheckIcon" class="me-2"></div>
                                <div id="userCheckMessage"></div>
                            </div>
                        </div>
                    </div>

                    <!-- å¯ç”¨çš„ç”¨æˆ·åˆ—è¡¨ -->
                    <div id="availableUsers" class="mt-3" style="display: none;">
                        <h6>æœåŠ¡å™¨ä¸­çš„å¯ç”¨ç”¨æˆ·ï¼š</h6>
                        <div id="userList" class="list-group"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å‘é€æµ‹è¯•é‚®ä»¶éƒ¨åˆ† -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-paper-plane me-2"></i>å‘é€æµ‹è¯•é‚®ä»¶</h5>
                </div>
                <div class="card-body">
                    <form id="emailSendForm">
                        <div class="mb-3">
                            <label for="fromEmail" class="form-label">å‘ä»¶äººé‚®ç®±</label>
                            <input type="email" class="form-control" id="fromEmail"
                                   placeholder="éªŒè¯é€šè¿‡çš„é‚®ç®±åœ°å€" required>
                        </div>
                        <div class="mb-3">
                            <label for="toEmail" class="form-label">æ”¶ä»¶äººé‚®ç®±</label>
                            <input type="email" class="form-control" id="toEmail"
                                   placeholder="ç›®æ ‡é‚®ç®±åœ°å€" required>
                        </div>
                        <div class="mb-3">
                            <label for="templateType" class="form-label">é‚®ä»¶æ¨¡æ¿</label>
                            <select class="form-select" id="templateType">
                                <option value="plain">çº¯æ–‡æœ¬é‚®ä»¶</option>
                                <option value="html">HTMLé‚®ä»¶</option>
                                <option value="phishing">ä¸“ä¸šé‚®ä»¶æ¨¡æ¿</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="subject" class="form-label">é‚®ä»¶ä¸»é¢˜</label>
                            <input type="text" class="form-control" id="subject"
                                   value="SEEDé‚®ä»¶ç³»ç»Ÿæµ‹è¯•é‚®ä»¶" required>
                        </div>
                        <div class="mb-3">
                            <label for="body" class="form-label">é‚®ä»¶å†…å®¹</label>
                            <textarea class="form-control" id="body" rows="4"
                                      placeholder="è¾“å…¥é‚®ä»¶å†…å®¹...">è¿™æ˜¯ä¸€å°æ¥è‡ªSEEDé‚®ä»¶ç³»ç»Ÿçš„æµ‹è¯•é‚®ä»¶ã€‚</textarea>
                        </div>
                        <button type="submit" class="btn btn-success" id="sendEmailBtn">
                            <i class="fas fa-paper-plane me-2"></i>å‘é€é‚®ä»¶
                        </button>
                    </form>

                    <!-- å‘é€ç»“æœ -->
                    <div id="emailSendResult" class="mt-3" style="display: none;">
                        <div class="alert" role="alert">
                            <div class="d-flex">
                                <div id="emailSendIcon" class="me-2"></div>
                                <div id="emailSendMessage"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æµ‹è¯•å†å²è®°å½• -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-history me-2"></i>æµ‹è¯•å†å²è®°å½•</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped" id="testHistoryTable">
                            <thead>
                                <tr>
                                    <th>æ—¶é—´</th>
                                    <th>æ“ä½œç±»å‹</th>
                                    <th>é‚®ç®±åœ°å€</th>
                                    <th>æœåŠ¡å™¨</th>
                                    <th>çŠ¶æ€</th>
                                    <th>è¯¦æƒ…</th>
                                </tr>
                            </thead>
                            <tbody id="testHistoryBody">
                                <!-- åŠ¨æ€å¡«å…… -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// æµ‹è¯•å†å²è®°å½•
let testHistory = [];

function addToHistory(type, email, server, status, details = '') {
    const timestamp = new Date().toLocaleString();
    testHistory.unshift({
        timestamp,
        type,
        email,
        server,
        status,
        details
    });

    updateHistoryTable();
}

function updateHistoryTable() {
    const tbody = document.getElementById('testHistoryBody');
    tbody.innerHTML = '';

    testHistory.slice(0, 10).forEach(item => {
        const row = `
            <tr>
                <td>${item.timestamp}</td>
                <td>
                    <span class="badge bg-${item.type === 'éªŒè¯' ? 'primary' : 'success'}">
                        ${item.type}
                    </span>
                </td>
                <td>${item.email}</td>
                <td>${item.server}</td>
                <td>
                    <span class="badge bg-${item.status === 'æˆåŠŸ' ? 'success' : 'danger'}">
                        ${item.status}
                    </span>
                </td>
                <td>${item.details}</td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

// ç”¨æˆ·éªŒè¯åŠŸèƒ½
document.getElementById('userCheckForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const email = document.getElementById('emailInput').value;
    const serverId = document.getElementById('serverSelect').value;

    if (!email || !serverId) {
        showUserCheckResult('danger', 'fas fa-exclamation-triangle', 'è¯·å¡«å†™å®Œæ•´çš„é‚®ç®±åœ°å€å’Œé€‰æ‹©æœåŠ¡å™¨');
        return;
    }

    const checkBtn = document.getElementById('checkUserBtn');
    const originalText = checkBtn.innerHTML;
    checkBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>éªŒè¯ä¸­...';
    checkBtn.disabled = true;

    try {
        const response = await fetch('/api/check_user', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                email: email,
                server_id: serverId
            })
        });

        const result = await response.json();

        if (result.success && result.user_exists) {
            showUserCheckResult('success', 'fas fa-check-circle', result.message);
            document.getElementById('fromEmail').value = email;
            addToHistory('éªŒè¯', email, result.server.name, 'æˆåŠŸ', 'ç”¨æˆ·å­˜åœ¨');
        } else {
            showUserCheckResult('warning', 'fas fa-exclamation-triangle', result.message);
            addToHistory('éªŒè¯', email, 'æœªçŸ¥æœåŠ¡å™¨', 'å¤±è´¥', result.message);

            // æ˜¾ç¤ºå¯ç”¨ç”¨æˆ·åˆ—è¡¨
            if (result.available_users && result.available_users.length > 0) {
                showAvailableUsers(result.available_users);
            }
        }
    } catch (error) {
        showUserCheckResult('danger', 'fas fa-times-circle', 'éªŒè¯å¤±è´¥: ' + error.message);
        addToHistory('éªŒè¯', email, 'æœªçŸ¥æœåŠ¡å™¨', 'é”™è¯¯', error.message);
    } finally {
        checkBtn.innerHTML = originalText;
        checkBtn.disabled = false;
    }
});

function showUserCheckResult(alertType, icon, message) {
    const resultDiv = document.getElementById('userCheckResult');
    const iconDiv = document.getElementById('userCheckIcon');
    const messageDiv = document.getElementById('userCheckMessage');

    resultDiv.className = `alert alert-${alertType}`;
    iconDiv.innerHTML = `<i class="${icon}"></i>`;
    messageDiv.textContent = message;

    resultDiv.style.display = 'block';
}

function showAvailableUsers(users) {
    const container = document.getElementById('availableUsers');
    const userList = document.getElementById('userList');

    userList.innerHTML = '';
    users.forEach(user => {
        const item = document.createElement('button');
        item.className = 'list-group-item list-group-item-action';
        item.textContent = user;
        item.onclick = () => {
            document.getElementById('emailInput').value = user;
        };
        userList.appendChild(item);
    });

    container.style.display = 'block';
}

// é‚®ä»¶å‘é€åŠŸèƒ½
document.getElementById('emailSendForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const fromEmail = document.getElementById('fromEmail').value;
    const toEmail = document.getElementById('toEmail').value;
    const subject = document.getElementById('subject').value;
    const body = document.getElementById('body').value;

    if (!fromEmail || !toEmail) {
        showEmailSendResult('danger', 'fas fa-exclamation-triangle', 'è¯·å¡«å†™å‘ä»¶äººå’Œæ”¶ä»¶äººé‚®ç®±');
        return;
    }

    const sendBtn = document.getElementById('sendEmailBtn');
    const originalText = sendBtn.innerHTML;
    sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>å‘é€ä¸­...';
    sendBtn.disabled = true;

    try {
        const templateType = document.getElementById('templateType').value;

        const response = await fetch('/api/send_test_email', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                from_email: fromEmail,
                to_email: toEmail,
                subject: subject,
                body: body,
                template: templateType
            })
        });

        const result = await response.json();

        if (result.success) {
            showEmailSendResult('success', 'fas fa-check-circle', result.message);
            addToHistory('å‘é€', fromEmail, result.details.server, 'æˆåŠŸ', `å‘é€åˆ° ${toEmail}`);
        } else {
            showEmailSendResult('danger', 'fas fa-times-circle', result.message);
            addToHistory('å‘é€', fromEmail, 'æœªçŸ¥æœåŠ¡å™¨', 'å¤±è´¥', result.message);
        }
    } catch (error) {
        showEmailSendResult('danger', 'fas fa-times-circle', 'å‘é€å¤±è´¥: ' + error.message);
        addToHistory('å‘é€', fromEmail, 'æœªçŸ¥æœåŠ¡å™¨', 'é”™è¯¯', error.message);
    } finally {
        sendBtn.innerHTML = originalText;
        sendBtn.disabled = false;
    }
});

function showEmailSendResult(alertType, icon, message) {
    const resultDiv = document.getElementById('emailSendResult');
    const iconDiv = document.getElementById('emailSendIcon');
    const messageDiv = document.getElementById('emailSendMessage');

    resultDiv.className = `alert alert-${alertType}`;
    iconDiv.innerHTML = `<i class="${icon}"></i>`;
    messageDiv.textContent = message;

    resultDiv.style.display = 'block';
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    console.log('é‚®ä»¶å‘ä¿¡æµ‹è¯•é¡µé¢å·²åŠ è½½');
});
</script>

{% endblock %}
