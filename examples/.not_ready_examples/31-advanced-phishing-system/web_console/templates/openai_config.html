{% extends "base.html" %}

{% block title %}OpenAI配置管理 - SEED高级钓鱼系统{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- 页面标题 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 text-primary cyber-text">
                <i class="fas fa-cog"></i> OpenAI配置管理
            </h1>
            <p class="text-muted">自定义API密钥和模型配置管理</p>
        </div>
        <div>
            <span class="badge badge-pill bg-primary">配置管理</span>
            <button class="btn btn-primary ms-2" onclick="loadCurrentConfig()">
                <i class="fas fa-sync-alt"></i> 刷新配置
            </button>
        </div>
    </div>

    <!-- 配置状态 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-dark border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle"></i> 当前配置状态
                        <span id="config-status-badge" class="badge bg-secondary float-end">加载中...</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row" id="config-status-content">
                        <!-- 动态加载配置状态 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- API密钥配置 -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card bg-dark border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-key"></i> API密钥配置
                    </h5>
                </div>
                <div class="card-body">
                    <form id="apiKeyForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">OpenAI API Key</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control hacker-console" id="api-key-input"
                                               name="api_key" placeholder="sk-..." required>
                                        <button class="btn btn-outline-secondary" type="button" onclick="toggleApiKey()">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <div class="form-text text-muted">
                                        <i class="fas fa-info-circle"></i>
                                        您的OpenAI API密钥，格式：sk-...
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Base URL (可选)</label>
                                    <input type="url" class="form-control hacker-console" id="base-url-input"
                                           name="base_url" placeholder="https://api.openai.com/v1"
                                           value="https://www.dmxapi.cn/v1">
                                    <div class="form-text text-muted">
                                        <i class="fas fa-globe"></i>
                                        API服务地址，默认使用官方地址
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">默认模型</label>
                                    <select class="form-select" id="default-model-select" name="default_model">
                                        <option value="gpt-4o">GPT-4o (推荐)</option>
                                        <option value="gpt-4-turbo">GPT-4 Turbo</option>
                                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                        <option value="claude-3-opus">Claude 3 Opus</option>
                                        <option value="claude-3-sonnet">Claude 3 Sonnet</option>
                                    </select>
                                    <div class="form-text text-muted">
                                        <i class="fas fa-robot"></i>
                                        用于自动任务的默认模型
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">最大Token数</label>
                                    <input type="number" class="form-control" id="max-tokens-input"
                                           name="max_tokens" value="4096" min="100" max="128000">
                                    <div class="form-text text-muted">
                                        <i class="fas fa-hashtag"></i>
                                        每次请求的最大token数量
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <button type="button" class="btn btn-outline-info" onclick="testConnection()">
                                    <i class="fas fa-plug"></i> 测试连接
                                </button>
                                <button type="button" class="btn btn-outline-warning" onclick="validateKey()">
                                    <i class="fas fa-check-circle"></i> 验证密钥
                                </button>
                                <button type="button" class="btn btn-outline-danger" onclick="clearConfig()">
                                    <i class="fas fa-trash"></i> 清空配置
                                </button>
                            </div>
                            <div>
                                <button type="button" class="btn btn-secondary" onclick="resetToDefaults()">
                                    <i class="fas fa-undo"></i> 重置默认
                                </button>
                                <button type="button" class="btn btn-cyber" onclick="saveConfig()">
                                    <i class="fas fa-save"></i> 保存配置
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 配置帮助 -->
        <div class="col-lg-4">
            <div class="card bg-dark border-info">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-question-circle"></i> 配置帮助
                    </h5>
                </div>
                <div class="card-body">
                    <h6 class="text-info">获取OpenAI API密钥</h6>
                    <ol class="text-muted small">
                        <li>访问 <a href="https://platform.openai.com/api-keys" target="_blank" class="text-info">OpenAI平台</a></li>
                        <li>登录您的账户</li>
                        <li>点击"Create new secret key"</li>
                        <li>复制生成的密钥</li>
                        <li>粘贴到上面的输入框</li>
                    </ol>

                    <hr class="my-3">

                    <h6 class="text-warning">安全提醒</h6>
                    <ul class="text-muted small">
                        <li><i class="fas fa-shield-alt text-warning"></i> API密钥仅存储在本地</li>
                        <li><i class="fas fa-lock text-warning"></i> 不会上传到任何服务器</li>
                        <li><i class="fas fa-user-secret text-warning"></i> 请妥善保管您的密钥</li>
                        <li><i class="fas fa-dollar-sign text-warning"></i> 注意API使用费用</li>
                    </ul>

                    <hr class="my-3">

                    <h6 class="text-success">第三方服务</h6>
                    <p class="text-muted small">
                        如果您使用第三方API服务，请确保：
                    </p>
                    <ul class="text-muted small">
                        <li>服务稳定可靠</li>
                        <li>支持所需模型</li>
                        <li>费用合理透明</li>
                        <li>数据安全有保障</li>
                    </ul>
                </div>
            </div>

            <!-- 使用统计 -->
            <div class="card bg-dark border-warning mt-3">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar"></i> 使用统计
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <div class="metric-card h-100">
                                <i class="fas fa-robot fa-2x text-warning mb-2"></i>
                                <h4 class="text-warning" id="requests-count">0</h4>
                                <p class="card-text small">总请求数</p>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="metric-card h-100">
                                <i class="fas fa-coins fa-2x text-success mb-2"></i>
                                <h4 class="text-success" id="tokens-used">0</h4>
                                <p class="card-text small">Token使用</p>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid">
                        <button type="button" class="btn btn-warning btn-sm" onclick="resetStats()">
                            <i class="fas fa-refresh"></i> 重置统计
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 模型测试 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-dark border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-flask"></i> 模型可用性测试
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label class="form-label">选择要测试的模型</label>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="test-gpt4o" checked>
                                            <label class="form-check-label" for="test-gpt4o">
                                                GPT-4o <span class="badge bg-success">推荐</span>
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="test-gpt4turbo" checked>
                                            <label class="form-check-label" for="test-gpt4turbo">
                                                GPT-4 Turbo
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="test-gpt35" checked>
                                            <label class="form-check-label" for="test-gpt35">
                                                GPT-3.5 Turbo
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="test-claude-opus">
                                            <label class="form-check-label" for="test-claude-opus">
                                                Claude 3 Opus
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="test-claude-sonnet">
                                            <label class="form-check-label" for="test-claude-sonnet">
                                                Claude 3 Sonnet
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-primary" onclick="testSelectedModels()">
                                    <i class="fas fa-play"></i> 开始测试
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="stopTesting()">
                                    <i class="fas fa-stop"></i> 停止测试
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <div id="test-results" class="hacker-console" style="min-height: 200px; max-height: 400px; overflow-y: auto;">
                            <div class="text-center text-muted" style="padding-top: 70px;">
                                <i class="fas fa-flask fa-3x mb-3"></i>
                                <p>准备测试模型可用性...</p>
                                <small>点击"开始测试"运行测试</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 快速配置模板 -->
    <div class="row">
        <div class="col-12">
            <div class="card bg-dark border-secondary">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-magic"></i> 快速配置模板
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="card bg-info text-white h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-bolt fa-2x mb-2"></i>
                                    <h6>高性能配置</h6>
                                    <p class="card-text small">使用GPT-4o，最大限度发挥AI能力</p>
                                    <button type="button" class="btn btn-light btn-sm" onclick="loadTemplate('high-performance')">
                                        应用配置
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card bg-success text-white h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-dollar-sign fa-2x mb-2"></i>
                                    <h6>经济配置</h6>
                                    <p class="card-text small">使用GPT-3.5，平衡性能和成本</p>
                                    <button type="button" class="btn btn-light btn-sm" onclick="loadTemplate('economic')">
                                        应用配置
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card bg-warning text-dark h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-balance-scale fa-2x mb-2"></i>
                                    <h6>平衡配置</h6>
                                    <p class="card-text small">使用GPT-4 Turbo，性能与成本的最佳平衡</p>
                                    <button type="button" class="btn btn-dark btn-sm" onclick="loadTemplate('balanced')">
                                        应用配置
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 配置保存确认模态框 -->
<div class="modal fade modal-dark" id="saveConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header border-success">
                <h5 class="modal-title">
                    <i class="fas fa-save text-success"></i> 确认保存配置
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>您确定要保存当前的API配置吗？</p>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    配置将立即生效，并重启相关服务。
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-success" onclick="confirmSaveConfig()">确认保存</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 全局变量
let currentConfig = {};
let isTesting = false;

// 页面加载完成后的初始化
document.addEventListener('DOMContentLoaded', function() {
    loadCurrentConfig();
    loadUsageStats();

    // 密码显示切换
    window.toggleApiKey = function() {
        const input = document.getElementById('api-key-input');
        const icon = input.nextElementSibling.querySelector('i');

        if (input.type === 'password') {
            input.type = 'text';
            icon.className = 'fas fa-eye-slash';
        } else {
            input.type = 'password';
            icon.className = 'fas fa-eye';
        }
    };
});

// 加载当前配置
function loadCurrentConfig() {
    fetch('/api/openai_config')
    .then(response => response.json())
    .then(data => {
        updateConfigDisplay(data);
        currentConfig = data;
    })
    .catch(error => {
        console.error('加载配置失败:', error);
        showToast('加载配置失败', 'error');
    });
}

// 更新配置显示
function updateConfigDisplay(config) {
    // 更新状态徽章
    const statusBadge = document.getElementById('config-status-badge');
    const statusContent = document.getElementById('config-status-content');

    if (config.api_key_configured && config.connection_status === 'online') {
        statusBadge.className = 'badge bg-success float-end';
        statusBadge.textContent = '已配置';
    } else if (config.api_key_configured) {
        statusBadge.className = 'badge bg-warning float-end';
        statusBadge.textContent = '配置但离线';
    } else {
        statusBadge.className = 'badge bg-danger float-end';
        statusBadge.textContent = '未配置';
    }

    // 更新状态内容
    statusContent.innerHTML = `
        <div class="col-md-3">
            <div class="text-center">
                <i class="fas fa-key fa-2x ${config.api_key_configured ? 'text-success' : 'text-danger'} mb-2"></i>
                <h6>API密钥</h6>
                <p class="mb-0">${config.api_key_configured ? '已配置' : '未配置'}</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="text-center">
                <i class="fas fa-plug fa-2x ${config.connection_status === 'online' ? 'text-success' : 'text-danger'} mb-2"></i>
                <h6>连接状态</h6>
                <p class="mb-0">${config.connection_status === 'online' ? '在线' : '离线'}</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="text-center">
                <i class="fas fa-robot fa-2x text-primary mb-2"></i>
                <h6>默认模型</h6>
                <p class="mb-0">${config.default_model || '未设置'}</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="text-center">
                <i class="fas fa-clock fa-2x text-info mb-2"></i>
                <h6>最后测试</h6>
                <p class="mb-0">${config.last_test ? formatTimestamp(config.last_test) : '未测试'}</p>
            </div>
        </div>
    `;

    // 填充表单
    document.getElementById('api-key-input').value = config.api_key || '';
    document.getElementById('base-url-input').value = config.base_url || 'https://api.openai.com/v1';
    document.getElementById('default-model-select').value = config.default_model || 'gpt-4o';
    document.getElementById('max-tokens-input').value = config.max_tokens || 4096;
}

// 保存配置
function saveConfig() {
    const form = document.getElementById('apiKeyForm');
    const formData = new FormData(form);

    const configData = {
        api_key: formData.get('api_key'),
        base_url: formData.get('base_url'),
        default_model: formData.get('default_model'),
        max_tokens: parseInt(formData.get('max_tokens'))
    };

    if (!configData.api_key.trim()) {
        showToast('请输入API密钥', 'warning');
        return;
    }

    // 显示确认模态框
    const modal = new bootstrap.Modal(document.getElementById('saveConfirmModal'));
    modal.show();

    // 存储配置数据以供确认时使用
    window.pendingConfig = configData;
}

function confirmSaveConfig() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('saveConfirmModal'));
    modal.hide();

    fetch('/api/openai_config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(window.pendingConfig)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showToast('配置保存成功', 'success');
            setTimeout(() => loadCurrentConfig(), 1000);
        } else {
            showToast('配置保存失败: ' + result.error, 'error');
        }
    })
    .catch(error => {
        showToast('配置保存失败: ' + error.message, 'error');
    });
}

// 测试连接
function testConnection() {
    const form = document.getElementById('apiKeyForm');
    const formData = new FormData(form);

    const testData = {
        api_key: formData.get('api_key'),
        base_url: formData.get('base_url')
    };

    if (!testData.api_key.trim()) {
        showToast('请输入API密钥进行测试', 'warning');
        return;
    }

    showToast('正在测试连接...', 'info');

    fetch('/api/openai_test_connection', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(testData)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showToast('连接测试成功', 'success');
        } else {
            showToast('连接测试失败: ' + result.error, 'error');
        }
    })
    .catch(error => {
        showToast('连接测试失败: ' + error.message, 'error');
    });
}

// 验证密钥
function validateKey() {
    const apiKey = document.getElementById('api-key-input').value.trim();

    if (!apiKey) {
        showToast('请输入API密钥', 'warning');
        return;
    }

    if (!apiKey.startsWith('sk-')) {
        showToast('API密钥格式不正确，应以 sk- 开头', 'warning');
        return;
    }

    showToast('API密钥格式正确', 'success');
}

// 清空配置
function clearConfig() {
    if (confirm('确定要清空所有配置吗？此操作无法撤销。')) {
        document.getElementById('api-key-input').value = '';
        document.getElementById('base-url-input').value = 'https://api.openai.com/v1';
        document.getElementById('default-model-select').value = 'gpt-4o';
        document.getElementById('max-tokens-input').value = '4096';
        showToast('配置已清空', 'info');
    }
}

// 重置为默认配置
function resetToDefaults() {
    document.getElementById('api-key-input').value = 'sk-Q3EsPIoMUzEnhZapg1NYhgF2FvR9YVvuZTSPynitaujg2a6B';
    document.getElementById('base-url-input').value = 'https://www.dmxapi.cn/v1';
    document.getElementById('default-model-select').value = 'gpt-4o';
    document.getElementById('max-tokens-input').value = '4096';
    showToast('已重置为默认配置', 'info');
}

// 加载配置模板
function loadTemplate(template) {
    const templates = {
        'high-performance': {
            api_key: '',
            base_url: 'https://api.openai.com/v1',
            default_model: 'gpt-4o',
            max_tokens: 4096
        },
        'economic': {
            api_key: '',
            base_url: 'https://api.openai.com/v1',
            default_model: 'gpt-3.5-turbo',
            max_tokens: 2048
        },
        'balanced': {
            api_key: '',
            base_url: 'https://api.openai.com/v1',
            default_model: 'gpt-4-turbo',
            max_tokens: 4096
        }
    };

    const config = templates[template];
    if (config) {
        document.getElementById('api-key-input').value = config.api_key;
        document.getElementById('base-url-input').value = config.base_url;
        document.getElementById('default-model-select').value = config.default_model;
        document.getElementById('max-tokens-input').value = config.max_tokens;

        const templateNames = {
            'high-performance': '高性能配置',
            'economic': '经济配置',
            'balanced': '平衡配置'
        };

        showToast(`已加载${templateNames[template]}模板`, 'success');
    }
}

// 测试选中的模型
function testSelectedModels() {
    if (isTesting) {
        showToast('测试正在进行中，请稍后', 'warning');
        return;
    }

    const selectedModels = [];
    const checkboxes = [
        { id: 'test-gpt4o', model: 'gpt-4o' },
        { id: 'test-gpt4turbo', model: 'gpt-4-turbo' },
        { id: 'test-gpt35', model: 'gpt-3.5-turbo' },
        { id: 'test-claude-opus', model: 'claude-3-opus' },
        { id: 'test-claude-sonnet', model: 'claude-3-sonnet' }
    ];

    checkboxes.forEach(item => {
        if (document.getElementById(item.id).checked) {
            selectedModels.push(item.model);
        }
    });

    if (selectedModels.length === 0) {
        showToast('请至少选择一个模型进行测试', 'warning');
        return;
    }

    isTesting = true;
    const resultsDiv = document.getElementById('test-results');
    resultsDiv.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">测试中...</span></div><p class="mt-2">正在测试模型可用性...</p></div>';

    let completedTests = 0;
    let results = [];

    selectedModels.forEach(model => {
        fetch('/api/openai_test_model', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ model: model })
        })
        .then(response => response.json())
        .then(result => {
            completedTests++;
            results.push({
                model: model,
                success: result.success,
                response_time: result.response_time,
                error: result.error
            });

            // 更新显示
            updateTestResults(results, completedTests, selectedModels.length);

            if (completedTests === selectedModels.length) {
                isTesting = false;
                showToast('模型测试完成', 'success');
            }
        })
        .catch(error => {
            completedTests++;
            results.push({
                model: model,
                success: false,
                response_time: null,
                error: error.message
            });

            updateTestResults(results, completedTests, selectedModels.length);

            if (completedTests === selectedModels.length) {
                isTesting = false;
                showToast('模型测试完成', 'success');
            }
        });
    });
}

function updateTestResults(results, completed, total) {
    const resultsDiv = document.getElementById('test-results');

    let html = `<div class="mb-3"><strong>测试进度: ${completed}/${total}</strong></div>`;

    results.forEach(result => {
        const statusIcon = result.success ? 'fas fa-check-circle text-success' : 'fas fa-times-circle text-danger';
        const statusText = result.success ? '可用' : '不可用';
        const responseTime = result.response_time ? `${result.response_time}ms` : 'N/A';

        html += `
            <div class="mb-2 p-2 border rounded">
                <div class="d-flex justify-content-between align-items-center">
                    <span><strong>${result.model}</strong></span>
                    <div>
                        <i class="${statusIcon} me-2"></i>
                        <span class="${result.success ? 'text-success' : 'text-danger'}">${statusText}</span>
                        <small class="text-muted ms-2">${responseTime}</small>
                    </div>
                </div>
                ${result.error ? `<div class="text-danger small mt-1">${result.error}</div>` : ''}
            </div>
        `;
    });

    if (completed < total) {
        html += '<div class="text-center mt-3"><div class="spinner-border text-primary spinner-border-sm" role="status"><span class="visually-hidden">测试中...</span></div><small class="text-muted ms-2">继续测试中...</small></div>';
    }

    resultsDiv.innerHTML = html;
}

function stopTesting() {
    isTesting = false;
    showToast('测试已停止', 'info');
}

// 加载使用统计
function loadUsageStats() {
    fetch('/api/openai_usage_stats')
    .then(response => response.json())
    .then(data => {
        document.getElementById('requests-count').textContent = data.total_requests || 0;
        document.getElementById('tokens-used').textContent = data.total_tokens || 0;
    })
    .catch(error => {
        console.error('加载统计失败:', error);
    });
}

// 重置统计
function resetStats() {
    if (confirm('确定要重置使用统计吗？')) {
        fetch('/api/openai_reset_stats', { method: 'POST' })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                loadUsageStats();
                showToast('统计已重置', 'success');
            } else {
                showToast('重置失败', 'error');
            }
        })
        .catch(error => {
            showToast('重置失败: ' + error.message, 'error');
        });
    }
}
</script>
{% endblock %}
