<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>⚡ 快速攻击配置</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f8fafc;
            color: #1e293b;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 24px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 32px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 8px;
        }
        
        .header p {
            color: #64748b;
            font-size: 1.1rem;
        }
        
        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #f1f5f9;
            border: none;
            border-radius: 8px;
            color: #475569;
            text-decoration: none;
            font-weight: 500;
            margin-bottom: 24px;
            transition: all 0.2s;
        }
        
        .back-btn:hover {
            background: #e2e8f0;
        }
        
        .attack-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }
        
        .attack-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .attack-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .attack-card.selected {
            border-color: #3b82f6;
            background: #f8faff;
        }
        
        .attack-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .attack-icon {
            font-size: 2rem;
        }
        
        .attack-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #0f172a;
        }
        
        .attack-description {
            color: #64748b;
            margin-bottom: 16px;
            line-height: 1.5;
        }
        
        .attack-details {
            display: grid;
            gap: 8px;
            font-size: 0.875rem;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .detail-label {
            color: #6b7280;
        }
        
        .detail-value {
            font-weight: 500;
        }
        
        .risk-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .risk-low {
            background: #d1fae5;
            color: #065f46;
        }
        
        .risk-medium {
            background: #fef3c7;
            color: #92400e;
        }
        
        .risk-high {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .risk-critical {
            background: #fde2e7;
            color: #7f1d1d;
        }
        
        .config-panel {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }
        
        .config-header {
            font-size: 1.5rem;
            font-weight: 600;
            color: #0f172a;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #374151;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.875rem;
            transition: border-color 0.2s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.875rem;
            background: white;
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn-warning {
            background: #f59e0b;
            color: white;
        }
        
        .btn-warning:hover {
            background: #d97706;
        }
        
        .btn-full {
            width: 100%;
            justify-content: center;
        }
        
        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.875rem;
        }
        
        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        
        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
        
        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        
        .hidden {
            display: none;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .progress {
            margin: 20px 0;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #f1f5f9;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #3b82f6;
            transition: width 0.3s;
            width: 0%;
        }
        
        .progress-text {
            text-align: center;
            margin-top: 8px;
            font-size: 0.875rem;
            color: #6b7280;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="back-btn">
            ← 返回主表盘
        </a>
        
        <div class="header">
            <h1>⚡ 快速攻击配置</h1>
            <p>选择攻击类型并快速配置钓鱼活动</p>
        </div>

        <div id="alert-area"></div>

        <!-- Attack Type Selection -->
        <div class="attack-grid">
            {% for key, server in attack_servers.items() %}
            <div class="attack-card" data-attack="{{ key }}" onclick="selectAttack('{{ key }}')">
                <div class="attack-header">
                    <div class="attack-icon">{{ server.icon }}</div>
                    <div class="attack-title">{{ server.name }}</div>
                </div>
                
                <div class="attack-description">
                    {% if key == 'xss' %}
                    跨站脚本攻击，通过注入恶意脚本获取用户cookie和会话信息
                    {% elif key == 'sqli' %}
                    SQL注入攻击，通过构造恶意SQL查询获取数据库敏感信息
                    {% elif key == 'heartbleed' %}
                    Heartbleed漏洞利用，通过SSL心跳机制泄露服务器内存数据
                    {% elif key == 'apt' %}
                    高级持续性威胁攻击链，模拟多阶段复杂攻击过程
                    {% elif key == 'malware' %}
                    恶意软件分析，模拟恶意文件投递和行为分析
                    {% elif key == 'redblue' %}
                    红蓝对抗演练，模拟攻防双方实战对抗场景
                    {% elif key == 'iot' %}
                    IoT设备安全测试，模拟物联网设备漏洞利用
                    {% else %}
                    自定义攻击服务器，可配置任意端口和攻击类型
                    {% endif %}
                </div>
                
                <div class="attack-details">
                    <div class="detail-row">
                        <span class="detail-label">端口:</span>
                        <span class="detail-value">{{ server.port }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">风险级别:</span>
                        <span class="risk-badge risk-{{ server.risk }}">{{ server.risk.upper() }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">状态:</span>
                        <span class="detail-value" id="status-{{ key }}">
                            {% if system_status.services.get(key) == 'online' %}
                            <span style="color: #10b981;">● 在线</span>
                            {% else %}
                            <span style="color: #ef4444;">● 离线</span>
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Configuration Panel -->
        <div class="config-panel">
            <div class="config-header">🎯 快速配置攻击参数</div>
            
            <form id="quick-attack-form">
                <div class="form-group">
                    <label class="form-label">攻击名称</label>
                    <input type="text" class="form-input" name="attack_name" id="attack-name" placeholder="输入攻击活动名称" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">目标邮箱 (每行一个)</label>
                    <textarea class="form-input form-textarea" name="target_emails" placeholder="zzw4257@gmail.com&#10;3230106267@zju.edu.cn&#10;809050685@qq.com" required>zzw4257@gmail.com
3230106267@zju.edu.cn
809050685@qq.com</textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">邮件类型</label>
                    <select class="form-select" name="email_type">
                        <option value="security_alert">🔒 安全警告</option>
                        <option value="system_update">🔄 系统更新</option>
                        <option value="account_verification">✅ 账户验证</option>
                        <option value="urgent_action">⚠️ 紧急操作</option>
                        <option value="reward_notification">🎁 奖励通知</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">伪装公司</label>
                    <input type="text" class="form-input" name="company_name" value="ZJU信息办" placeholder="输入伪装的公司或组织名称">
                </div>
                
                <div class="form-group">
                    <label class="form-label">钓鱼页面类型</label>
                    <select class="form-select" name="page_type">
                        <option value="login">🔐 登录验证页面</option>
                        <option value="verification">🛡️ 身份验证页面</option>
                        <option value="update_info">📝 信息更新页面</option>
                        <option value="security_check">🔍 安全检查页面</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">执行模式</label>
                    <select class="form-select" name="execution_mode">
                        <option value="immediate">🚀 立即执行</option>
                        <option value="scheduled">⏰ 定时执行 (1小时后)</option>
                        <option value="manual">👆 手动触发</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" name="use_ai_enhancement" value="true" checked>
                        <span class="form-label" style="margin: 0;">使用AI增强内容质量</span>
                    </label>
                </div>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" name="auto_redirect" value="true" checked>
                        <span class="form-label" style="margin: 0;">自动重定向到攻击服务器</span>
                    </label>
                </div>
                
                <input type="hidden" name="selected_attack" id="selected-attack" value="xss">
                
                <div class="progress hidden" id="progress-area">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <div class="progress-text" id="progress-text">准备中...</div>
                </div>
                
                <button type="submit" class="btn btn-warning btn-full">
                    <span>🚀</span>
                    启动快速攻击
                </button>
            </form>
        </div>
    </div>

    <script>
        let selectedAttack = 'xss';
        
        function selectAttack(attackType) {
            // Remove previous selection
            document.querySelectorAll('.attack-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Add selection to clicked card
            document.querySelector(`[data-attack="${attackType}"]`).classList.add('selected');
            
            // Update hidden input and global variable
            document.getElementById('selected-attack').value = attackType;
            selectedAttack = attackType;
            
            // Update attack name placeholder
            const attackName = document.getElementById('attack-name');
            const timestamp = new Date().toLocaleString('zh-CN').replace(/[/:]/g, '');
            attackName.value = `快速${attackType.toUpperCase()}攻击_${timestamp}`;
        }
        
        function showAlert(message, type = 'success') {
            const alertArea = document.getElementById('alert-area');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} fade-in`;
            alert.textContent = message;
            
            alertArea.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
        
        function updateProgress(percentage, text) {
            const progressArea = document.getElementById('progress-area');
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            
            if (percentage === 0) {
                progressArea.classList.add('hidden');
            } else {
                progressArea.classList.remove('hidden');
                progressFill.style.width = `${percentage}%`;
                progressText.textContent = text;
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize with first attack selected
            selectAttack('xss');
            
            // Setup form submission
            document.getElementById('quick-attack-form').addEventListener('submit', handleQuickAttack);
        });
        
        async function handleQuickAttack(e) {
            e.preventDefault();
            
            if (!confirm('确认启动快速攻击吗？这将自动创建用户组、生成邮件模板、创建钓鱼页面并启动攻击活动。')) {
                return;
            }
            
            const formData = new FormData(e.target);
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            // Disable submit button
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span>⏳</span> 正在执行...';
            
            try {
                // Step 1: Create user group
                updateProgress(10, '创建用户组...');
                await createUserGroupForAttack(formData);
                
                // Step 2: Generate email template
                updateProgress(30, '生成AI邮件模板...');
                await generateEmailForAttack(formData);
                
                // Step 3: Generate landing page
                updateProgress(50, '生成钓鱼页面...');
                await generatePageForAttack(formData);
                
                // Step 4: Launch campaign
                updateProgress(80, '启动钓鱼活动...');
                await launchAttackCampaign(formData);
                
                // Complete
                updateProgress(100, '攻击已成功启动！');
                showAlert('快速攻击配置完成！请检查Gophish管理界面查看活动状态。');
                
                setTimeout(() => {
                    updateProgress(0, '');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<span>🚀</span> 启动快速攻击';
                }, 3000);
                
            } catch (error) {
                updateProgress(0, '');
                showAlert('快速攻击失败: ' + error.message, 'error');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<span>🚀</span> 启动快速攻击';
            }
        }
        
        async function createUserGroupForAttack(formData) {
            const groupData = new FormData();
            groupData.append('group_name', formData.get('attack_name') + '_目标组');
            groupData.append('emails', formData.get('target_emails'));
            
            const response = await fetch('/create_group', {
                method: 'POST',
                body: groupData
            });
            
            const result = await response.json();
            if (!result.success) {
                throw new Error(result.message);
            }
            
            return result;
        }
        
        async function generateEmailForAttack(formData) {
            const emailData = new FormData();
            emailData.append('content_type', 'email');
            emailData.append('scenario_type', formData.get('email_type'));
            emailData.append('company_name', formData.get('company_name'));
            emailData.append('use_real_template', formData.get('use_ai_enhancement') ? 'true' : 'false');
            
            const response = await fetch('/generate_content', {
                method: 'POST',
                body: emailData
            });
            
            const result = await response.json();
            if (!result.success) {
                throw new Error(result.message);
            }
            
            return result;
        }
        
        async function generatePageForAttack(formData) {
            const pageData = new FormData();
            pageData.append('content_type', 'page');
            pageData.append('page_type', formData.get('page_type'));
            pageData.append('company_name', formData.get('company_name'));
            pageData.append('style', 'modern');
            
            const response = await fetch('/generate_content', {
                method: 'POST',
                body: pageData
            });
            
            const result = await response.json();
            if (!result.success) {
                throw new Error(result.message);
            }
            
            return result;
        }
        
        async function launchAttackCampaign(formData) {
            // Get latest resources
            const resourcesResponse = await fetch('/get_resources');
            const resources = await resourcesResponse.json();
            
            if (!resources.groups || resources.groups.length === 0) {
                throw new Error('未找到用户组');
            }
            
            if (!resources.templates || resources.templates.length === 0) {
                throw new Error('未找到邮件模板');
            }
            
            if (!resources.pages || resources.pages.length === 0) {
                throw new Error('未找到钓鱼页面');
            }
            
            // Use the most recently created resources
            const latestGroup = resources.groups[resources.groups.length - 1];
            const latestTemplate = resources.templates[resources.templates.length - 1];
            const latestPage = resources.pages[resources.pages.length - 1];
            
            const campaignData = new FormData();
            campaignData.append('campaign_name', formData.get('attack_name'));
            campaignData.append('group_id', latestGroup.id);
            campaignData.append('template_id', latestTemplate.id);
            campaignData.append('page_id', latestPage.id);
            campaignData.append('attack_server', formData.get('selected_attack'));
            campaignData.append('send_immediately', 'true');
            
            const response = await fetch('/launch_campaign', {
                method: 'POST',
                body: campaignData
            });
            
            const result = await response.json();
            if (!result.success) {
                throw new Error(result.message);
            }
            
            return result;
        }
        
        // Auto-refresh server status every 10 seconds
        setInterval(async function() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                // Update server status indicators
                Object.keys(data.services).forEach(key => {
                    const statusElement = document.getElementById(`status-${key}`);
                    if (statusElement) {
                        const isOnline = data.services[key] === 'online';
                        statusElement.innerHTML = isOnline 
                            ? '<span style="color: #10b981;">● 在线</span>'
                            : '<span style="color: #ef4444;">● 离线</span>';
                    }
                });
            } catch (error) {
                console.error('刷新状态失败:', error);
            }
        }, 10000);
    </script>
</body>
</html>
