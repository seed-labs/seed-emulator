<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âš¡ å¿«é€Ÿæ”»å‡»é…ç½®</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f8fafc;
            color: #1e293b;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 24px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 32px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 8px;
        }
        
        .header p {
            color: #64748b;
            font-size: 1.1rem;
        }
        
        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #f1f5f9;
            border: none;
            border-radius: 8px;
            color: #475569;
            text-decoration: none;
            font-weight: 500;
            margin-bottom: 24px;
            transition: all 0.2s;
        }
        
        .back-btn:hover {
            background: #e2e8f0;
        }
        
        .attack-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }
        
        .attack-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .attack-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .attack-card.selected {
            border-color: #3b82f6;
            background: #f8faff;
        }
        
        .attack-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .attack-icon {
            font-size: 2rem;
        }
        
        .attack-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #0f172a;
        }
        
        .attack-description {
            color: #64748b;
            margin-bottom: 16px;
            line-height: 1.5;
        }
        
        .attack-details {
            display: grid;
            gap: 8px;
            font-size: 0.875rem;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .detail-label {
            color: #6b7280;
        }
        
        .detail-value {
            font-weight: 500;
        }
        
        .risk-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .risk-low {
            background: #d1fae5;
            color: #065f46;
        }
        
        .risk-medium {
            background: #fef3c7;
            color: #92400e;
        }
        
        .risk-high {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .risk-critical {
            background: #fde2e7;
            color: #7f1d1d;
        }
        
        .config-panel {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }
        
        .config-header {
            font-size: 1.5rem;
            font-weight: 600;
            color: #0f172a;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #374151;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.875rem;
            transition: border-color 0.2s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.875rem;
            background: white;
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn-warning {
            background: #f59e0b;
            color: white;
        }
        
        .btn-warning:hover {
            background: #d97706;
        }
        
        .btn-full {
            width: 100%;
            justify-content: center;
        }
        
        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.875rem;
        }
        
        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        
        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
        
        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        
        .hidden {
            display: none;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .progress {
            margin: 20px 0;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #f1f5f9;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #3b82f6;
            transition: width 0.3s;
            width: 0%;
        }
        
        .progress-text {
            text-align: center;
            margin-top: 8px;
            font-size: 0.875rem;
            color: #6b7280;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="back-btn">
            â† è¿”å›ä¸»è¡¨ç›˜
        </a>
        
        <div class="header">
            <h1>âš¡ å¿«é€Ÿæ”»å‡»é…ç½®</h1>
            <p>é€‰æ‹©æ”»å‡»ç±»å‹å¹¶å¿«é€Ÿé…ç½®é’“é±¼æ´»åŠ¨</p>
        </div>

        <div id="alert-area"></div>

        <!-- Attack Type Selection -->
        <div class="attack-grid">
            {% for key, server in attack_servers.items() %}
            <div class="attack-card" data-attack="{{ key }}" onclick="selectAttack('{{ key }}')">
                <div class="attack-header">
                    <div class="attack-icon">{{ server.icon }}</div>
                    <div class="attack-title">{{ server.name }}</div>
                </div>
                
                <div class="attack-description">
                    {% if key == 'xss' %}
                    è·¨ç«™è„šæœ¬æ”»å‡»ï¼Œé€šè¿‡æ³¨å…¥æ¶æ„è„šæœ¬è·å–ç”¨æˆ·cookieå’Œä¼šè¯ä¿¡æ¯
                    {% elif key == 'sqli' %}
                    SQLæ³¨å…¥æ”»å‡»ï¼Œé€šè¿‡æ„é€ æ¶æ„SQLæŸ¥è¯¢è·å–æ•°æ®åº“æ•æ„Ÿä¿¡æ¯
                    {% elif key == 'heartbleed' %}
                    Heartbleedæ¼æ´åˆ©ç”¨ï¼Œé€šè¿‡SSLå¿ƒè·³æœºåˆ¶æ³„éœ²æœåŠ¡å™¨å†…å­˜æ•°æ®
                    {% elif key == 'apt' %}
                    é«˜çº§æŒç»­æ€§å¨èƒæ”»å‡»é“¾ï¼Œæ¨¡æ‹Ÿå¤šé˜¶æ®µå¤æ‚æ”»å‡»è¿‡ç¨‹
                    {% elif key == 'malware' %}
                    æ¶æ„è½¯ä»¶åˆ†æï¼Œæ¨¡æ‹Ÿæ¶æ„æ–‡ä»¶æŠ•é€’å’Œè¡Œä¸ºåˆ†æ
                    {% elif key == 'redblue' %}
                    çº¢è“å¯¹æŠ—æ¼”ç»ƒï¼Œæ¨¡æ‹Ÿæ”»é˜²åŒæ–¹å®æˆ˜å¯¹æŠ—åœºæ™¯
                    {% elif key == 'iot' %}
                    IoTè®¾å¤‡å®‰å…¨æµ‹è¯•ï¼Œæ¨¡æ‹Ÿç‰©è”ç½‘è®¾å¤‡æ¼æ´åˆ©ç”¨
                    {% else %}
                    è‡ªå®šä¹‰æ”»å‡»æœåŠ¡å™¨ï¼Œå¯é…ç½®ä»»æ„ç«¯å£å’Œæ”»å‡»ç±»å‹
                    {% endif %}
                </div>
                
                <div class="attack-details">
                    <div class="detail-row">
                        <span class="detail-label">ç«¯å£:</span>
                        <span class="detail-value">{{ server.port }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">é£é™©çº§åˆ«:</span>
                        <span class="risk-badge risk-{{ server.risk }}">{{ server.risk.upper() }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">çŠ¶æ€:</span>
                        <span class="detail-value" id="status-{{ key }}">
                            {% if system_status.services.get(key) == 'online' %}
                            <span style="color: #10b981;">â— åœ¨çº¿</span>
                            {% else %}
                            <span style="color: #ef4444;">â— ç¦»çº¿</span>
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Configuration Panel -->
        <div class="config-panel">
            <div class="config-header">ğŸ¯ å¿«é€Ÿé…ç½®æ”»å‡»å‚æ•°</div>
            
            <form id="quick-attack-form">
                <div class="form-group">
                    <label class="form-label">æ”»å‡»åç§°</label>
                    <input type="text" class="form-input" name="attack_name" id="attack-name" placeholder="è¾“å…¥æ”»å‡»æ´»åŠ¨åç§°" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ç›®æ ‡é‚®ç®± (æ¯è¡Œä¸€ä¸ª)</label>
                    <textarea class="form-input form-textarea" name="target_emails" placeholder="zzw4257@gmail.com&#10;3230106267@zju.edu.cn&#10;809050685@qq.com" required>zzw4257@gmail.com
3230106267@zju.edu.cn
809050685@qq.com</textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">é‚®ä»¶ç±»å‹</label>
                    <select class="form-select" name="email_type">
                        <option value="security_alert">ğŸ”’ å®‰å…¨è­¦å‘Š</option>
                        <option value="system_update">ğŸ”„ ç³»ç»Ÿæ›´æ–°</option>
                        <option value="account_verification">âœ… è´¦æˆ·éªŒè¯</option>
                        <option value="urgent_action">âš ï¸ ç´§æ€¥æ“ä½œ</option>
                        <option value="reward_notification">ğŸ å¥–åŠ±é€šçŸ¥</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ä¼ªè£…å…¬å¸</label>
                    <input type="text" class="form-input" name="company_name" value="ZJUä¿¡æ¯åŠ" placeholder="è¾“å…¥ä¼ªè£…çš„å…¬å¸æˆ–ç»„ç»‡åç§°">
                </div>
                
                <div class="form-group">
                    <label class="form-label">é’“é±¼é¡µé¢ç±»å‹</label>
                    <select class="form-select" name="page_type">
                        <option value="login">ğŸ” ç™»å½•éªŒè¯é¡µé¢</option>
                        <option value="verification">ğŸ›¡ï¸ èº«ä»½éªŒè¯é¡µé¢</option>
                        <option value="update_info">ğŸ“ ä¿¡æ¯æ›´æ–°é¡µé¢</option>
                        <option value="security_check">ğŸ” å®‰å…¨æ£€æŸ¥é¡µé¢</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">æ‰§è¡Œæ¨¡å¼</label>
                    <select class="form-select" name="execution_mode">
                        <option value="immediate">ğŸš€ ç«‹å³æ‰§è¡Œ</option>
                        <option value="scheduled">â° å®šæ—¶æ‰§è¡Œ (1å°æ—¶å)</option>
                        <option value="manual">ğŸ‘† æ‰‹åŠ¨è§¦å‘</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" name="use_ai_enhancement" value="true" checked>
                        <span class="form-label" style="margin: 0;">ä½¿ç”¨AIå¢å¼ºå†…å®¹è´¨é‡</span>
                    </label>
                </div>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" name="auto_redirect" value="true" checked>
                        <span class="form-label" style="margin: 0;">è‡ªåŠ¨é‡å®šå‘åˆ°æ”»å‡»æœåŠ¡å™¨</span>
                    </label>
                </div>
                
                <input type="hidden" name="selected_attack" id="selected-attack" value="xss">
                
                <div class="progress hidden" id="progress-area">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <div class="progress-text" id="progress-text">å‡†å¤‡ä¸­...</div>
                </div>
                
                <button type="submit" class="btn btn-warning btn-full">
                    <span>ğŸš€</span>
                    å¯åŠ¨å¿«é€Ÿæ”»å‡»
                </button>
            </form>
        </div>
    </div>

    <script>
        let selectedAttack = 'xss';
        
        function selectAttack(attackType) {
            // Remove previous selection
            document.querySelectorAll('.attack-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Add selection to clicked card
            document.querySelector(`[data-attack="${attackType}"]`).classList.add('selected');
            
            // Update hidden input and global variable
            document.getElementById('selected-attack').value = attackType;
            selectedAttack = attackType;
            
            // Update attack name placeholder
            const attackName = document.getElementById('attack-name');
            const timestamp = new Date().toLocaleString('zh-CN').replace(/[/:]/g, '');
            attackName.value = `å¿«é€Ÿ${attackType.toUpperCase()}æ”»å‡»_${timestamp}`;
        }
        
        function showAlert(message, type = 'success') {
            const alertArea = document.getElementById('alert-area');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} fade-in`;
            alert.textContent = message;
            
            alertArea.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
        
        function updateProgress(percentage, text) {
            const progressArea = document.getElementById('progress-area');
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            
            if (percentage === 0) {
                progressArea.classList.add('hidden');
            } else {
                progressArea.classList.remove('hidden');
                progressFill.style.width = `${percentage}%`;
                progressText.textContent = text;
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize with first attack selected
            selectAttack('xss');
            
            // Setup form submission
            document.getElementById('quick-attack-form').addEventListener('submit', handleQuickAttack);
        });
        
        async function handleQuickAttack(e) {
            e.preventDefault();
            
            if (!confirm('ç¡®è®¤å¯åŠ¨å¿«é€Ÿæ”»å‡»å—ï¼Ÿè¿™å°†è‡ªåŠ¨åˆ›å»ºç”¨æˆ·ç»„ã€ç”Ÿæˆé‚®ä»¶æ¨¡æ¿ã€åˆ›å»ºé’“é±¼é¡µé¢å¹¶å¯åŠ¨æ”»å‡»æ´»åŠ¨ã€‚')) {
                return;
            }
            
            const formData = new FormData(e.target);
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            // Disable submit button
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span>â³</span> æ­£åœ¨æ‰§è¡Œ...';
            
            try {
                // Step 1: Create user group
                updateProgress(10, 'åˆ›å»ºç”¨æˆ·ç»„...');
                await createUserGroupForAttack(formData);
                
                // Step 2: Generate email template
                updateProgress(30, 'ç”ŸæˆAIé‚®ä»¶æ¨¡æ¿...');
                await generateEmailForAttack(formData);
                
                // Step 3: Generate landing page
                updateProgress(50, 'ç”Ÿæˆé’“é±¼é¡µé¢...');
                await generatePageForAttack(formData);
                
                // Step 4: Launch campaign
                updateProgress(80, 'å¯åŠ¨é’“é±¼æ´»åŠ¨...');
                await launchAttackCampaign(formData);
                
                // Complete
                updateProgress(100, 'æ”»å‡»å·²æˆåŠŸå¯åŠ¨ï¼');
                showAlert('å¿«é€Ÿæ”»å‡»é…ç½®å®Œæˆï¼è¯·æ£€æŸ¥Gophishç®¡ç†ç•Œé¢æŸ¥çœ‹æ´»åŠ¨çŠ¶æ€ã€‚');
                
                setTimeout(() => {
                    updateProgress(0, '');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<span>ğŸš€</span> å¯åŠ¨å¿«é€Ÿæ”»å‡»';
                }, 3000);
                
            } catch (error) {
                updateProgress(0, '');
                showAlert('å¿«é€Ÿæ”»å‡»å¤±è´¥: ' + error.message, 'error');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<span>ğŸš€</span> å¯åŠ¨å¿«é€Ÿæ”»å‡»';
            }
        }
        
        async function createUserGroupForAttack(formData) {
            const groupData = new FormData();
            groupData.append('group_name', formData.get('attack_name') + '_ç›®æ ‡ç»„');
            groupData.append('emails', formData.get('target_emails'));
            
            const response = await fetch('/create_group', {
                method: 'POST',
                body: groupData
            });
            
            const result = await response.json();
            if (!result.success) {
                throw new Error(result.message);
            }
            
            return result;
        }
        
        async function generateEmailForAttack(formData) {
            const emailData = new FormData();
            emailData.append('content_type', 'email');
            emailData.append('scenario_type', formData.get('email_type'));
            emailData.append('company_name', formData.get('company_name'));
            emailData.append('use_real_template', formData.get('use_ai_enhancement') ? 'true' : 'false');
            
            const response = await fetch('/generate_content', {
                method: 'POST',
                body: emailData
            });
            
            const result = await response.json();
            if (!result.success) {
                throw new Error(result.message);
            }
            
            return result;
        }
        
        async function generatePageForAttack(formData) {
            const pageData = new FormData();
            pageData.append('content_type', 'page');
            pageData.append('page_type', formData.get('page_type'));
            pageData.append('company_name', formData.get('company_name'));
            pageData.append('style', 'modern');
            
            const response = await fetch('/generate_content', {
                method: 'POST',
                body: pageData
            });
            
            const result = await response.json();
            if (!result.success) {
                throw new Error(result.message);
            }
            
            return result;
        }
        
        async function launchAttackCampaign(formData) {
            // Get latest resources
            const resourcesResponse = await fetch('/get_resources');
            const resources = await resourcesResponse.json();
            
            if (!resources.groups || resources.groups.length === 0) {
                throw new Error('æœªæ‰¾åˆ°ç”¨æˆ·ç»„');
            }
            
            if (!resources.templates || resources.templates.length === 0) {
                throw new Error('æœªæ‰¾åˆ°é‚®ä»¶æ¨¡æ¿');
            }
            
            if (!resources.pages || resources.pages.length === 0) {
                throw new Error('æœªæ‰¾åˆ°é’“é±¼é¡µé¢');
            }
            
            // Use the most recently created resources
            const latestGroup = resources.groups[resources.groups.length - 1];
            const latestTemplate = resources.templates[resources.templates.length - 1];
            const latestPage = resources.pages[resources.pages.length - 1];
            
            const campaignData = new FormData();
            campaignData.append('campaign_name', formData.get('attack_name'));
            campaignData.append('group_id', latestGroup.id);
            campaignData.append('template_id', latestTemplate.id);
            campaignData.append('page_id', latestPage.id);
            campaignData.append('attack_server', formData.get('selected_attack'));
            campaignData.append('send_immediately', 'true');
            
            const response = await fetch('/launch_campaign', {
                method: 'POST',
                body: campaignData
            });
            
            const result = await response.json();
            if (!result.success) {
                throw new Error(result.message);
            }
            
            return result;
        }
        
        // Auto-refresh server status every 10 seconds
        setInterval(async function() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                // Update server status indicators
                Object.keys(data.services).forEach(key => {
                    const statusElement = document.getElementById(`status-${key}`);
                    if (statusElement) {
                        const isOnline = data.services[key] === 'online';
                        statusElement.innerHTML = isOnline 
                            ? '<span style="color: #10b981;">â— åœ¨çº¿</span>'
                            : '<span style="color: #ef4444;">â— ç¦»çº¿</span>';
                    }
                });
            } catch (error) {
                console.error('åˆ·æ–°çŠ¶æ€å¤±è´¥:', error);
            }
        }, 10000);
    </script>
</body>
</html>
