#!/usr/bin/env python
"""
æ¶æ„è½¯ä»¶åˆ†ææ²™ç®±
åŠ¨æ€å’Œé™æ€æ¶æ„è½¯ä»¶åˆ†æå¹³å°
é›†æˆå¤šç§åˆ†æå·¥å…·å’Œå¨èƒæƒ…æŠ¥
"""

import os
import json
import time
import hashlib
import random
import sqlite3
import subprocess
import threading
from datetime import datetime
from flask import Flask, request, render_template_string, jsonify, send_file
import zipfile
import tempfile
import shutil

class MalwareSandbox:
    def __init__(self):
        self.base_dir = os.path.dirname(os.path.abspath(__file__))
        self.samples_dir = os.path.join(self.base_dir, "samples")
        self.reports_dir = os.path.join(self.base_dir, "reports")
        self.quarantine_dir = os.path.join(self.base_dir, "quarantine")
        
        os.makedirs(self.samples_dir, exist_ok=True)
        os.makedirs(self.reports_dir, exist_ok=True)
        os.makedirs(self.quarantine_dir, exist_ok=True)
        
        self.setup_database()
        self.create_sample_malware()
        
    def setup_database(self):
        """åˆå§‹åŒ–æ¶æ„è½¯ä»¶åˆ†ææ•°æ®åº“"""
        conn = sqlite3.connect('malware_analysis.db')
        cursor = conn.cursor()
        
        # æ ·æœ¬åˆ†æè¡¨
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS malware_samples (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                filename TEXT NOT NULL,
                md5_hash TEXT NOT NULL,
                sha1_hash TEXT NOT NULL,
                sha256_hash TEXT NOT NULL,
                file_size INTEGER,
                file_type TEXT,
                submission_time TEXT NOT NULL,
                analysis_status TEXT DEFAULT 'pending',
                threat_level TEXT DEFAULT 'unknown',
                family TEXT,
                capabilities TEXT,
                network_behavior TEXT,
                file_operations TEXT,
                registry_operations TEXT,
                process_operations TEXT
            )
        ''')
        
        # å¨èƒæƒ…æŠ¥è¡¨
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS threat_intelligence (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                hash_value TEXT NOT NULL,
                threat_name TEXT,
                family TEXT,
                source TEXT,
                description TEXT,
                iocs TEXT,
                ttps TEXT,
                update_time TEXT NOT NULL
            )
        ''')
        
        # åŠ¨æ€åˆ†æç»“æœè¡¨
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS dynamic_analysis (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                sample_id INTEGER,
                execution_time INTEGER,
                cpu_usage REAL,
                memory_usage REAL,
                network_connections TEXT,
                dns_queries TEXT,
                file_modifications TEXT,
                registry_modifications TEXT,
                api_calls TEXT,
                screenshots TEXT,
                FOREIGN KEY (sample_id) REFERENCES malware_samples (id)
            )
        ''')
        
        conn.commit()
        conn.close()
        
    def create_sample_malware(self):
        """åˆ›å»ºç¤ºä¾‹æ¶æ„è½¯ä»¶æ ·æœ¬(ä»…ç”¨äºæ¼”ç¤º)"""
        samples = [
            {
                "filename": "invoice.exe",
                "content": b"MZ\x90\x00" + b"FAKE_PE_HEADER" + b"\x00" * 100,
                "family": "TrickBot",
                "threat_level": "HIGH"
            },
            {
                "filename": "document.pdf.exe", 
                "content": b"%PDF-1.4" + b"FAKE_PDF_MALWARE" + b"\x00" * 150,
                "family": "Emotet",
                "threat_level": "CRITICAL"
            },
            {
                "filename": "photo.jpg.scr",
                "content": b"\xFF\xD8\xFF\xE0" + b"FAKE_IMAGE_MALWARE" + b"\x00" * 80,
                "family": "Ransomware",
                "threat_level": "CRITICAL"
            }
        ]
        
        for sample in samples:
            sample_path = os.path.join(self.samples_dir, sample["filename"])
            if not os.path.exists(sample_path):
                with open(sample_path, 'wb') as f:
                    f.write(sample["content"])

app = Flask(__name__)
sandbox = MalwareSandbox()

# æ¶æ„è½¯ä»¶åˆ†ææ²™ç®±é¡µé¢æ¨¡æ¿
SANDBOX_TEMPLATE = """
<!DOCTYPE html>
<html>
<head>
    <title>æ¶æ„è½¯ä»¶åˆ†ææ²™ç®±</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #1a1a1a; color: #e0e0e0; }
        .header { background: #2c1810; color: #ff9800; padding: 20px; margin: -20px -20px 20px -20px; border-bottom: 3px solid #ff5722; }
        .container { max-width: 1400px; margin: 0 auto; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .full-width { grid-column: 1 / -1; }
        .panel { background: #2a2a2a; padding: 20px; border-radius: 10px; border: 1px solid #444; }
        .upload-zone { border: 2px dashed #ff5722; padding: 40px; text-align: center; background: #2c1810; border-radius: 10px; cursor: pointer; transition: all 0.3s; }
        .upload-zone:hover { background: #3c2820; border-color: #ff9800; }
        .sample-item { background: #3a3a3a; padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #666; }
        .threat-high { border-left-color: #ff5722; }
        .threat-critical { border-left-color: #d32f2f; }
        .threat-medium { border-left-color: #ff9800; }
        .threat-low { border-left-color: #4caf50; }
        .btn { background: #ff5722; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #ff3d00; }
        .btn-analyze { background: #2196f3; }
        .btn-download { background: #4caf50; }
        .btn-quarantine { background: #f44336; }
        .analysis-result { background: #1e1e1e; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 12px; margin: 10px 0; }
        .ioc-item { background: #3c2415; padding: 8px; margin: 5px 0; border-radius: 3px; font-family: monospace; }
        .capability-tag { display: inline-block; background: #ff5722; color: white; padding: 3px 8px; border-radius: 3px; margin: 2px; font-size: 11px; }
        .progress-bar { background: #333; height: 20px; border-radius: 10px; overflow: hidden; margin: 10px 0; }
        .progress-fill { background: linear-gradient(90deg, #ff5722, #ff9800); height: 100%; transition: width 1s; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .stat-card { background: #3a3a3a; padding: 15px; border-radius: 5px; text-align: center; }
        .stat-value { font-size: 24px; font-weight: bold; margin-bottom: 5px; }
        .stat-label { font-size: 12px; opacity: 0.8; }
        .network-graph { background: #1e1e1e; padding: 20px; border-radius: 5px; height: 300px; overflow: auto; }
        .file-hash { font-family: monospace; font-size: 11px; color: #ff9800; word-break: break-all; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¦  æ¶æ„è½¯ä»¶åˆ†ææ²™ç®±</h1>
            <p>é«˜çº§æ¶æ„è½¯ä»¶åŠ¨æ€åˆ†æå’Œå¨èƒæƒ…æŠ¥å¹³å°</p>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" style="color: #ff5722;">{{ stats.total_samples }}</div>
                <div class="stat-label">æ ·æœ¬æ€»æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" style="color: #d32f2f;">{{ stats.critical_threats }}</div>
                <div class="stat-label">ä¸¥é‡å¨èƒ</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" style="color: #ff9800;">{{ stats.families_detected }}</div>
                <div class="stat-label">æ¶æ„è½¯ä»¶å®¶æ—</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" style="color: #4caf50;">{{ stats.analyzed_samples }}</div>
                <div class="stat-label">å·²åˆ†ææ ·æœ¬</div>
            </div>
        </div>
        
        <div class="grid">
            <div class="panel">
                <h3>ğŸ“ æ ·æœ¬ä¸Šä¼ </h3>
                <div class="upload-zone" onclick="document.getElementById('file-input').click()">
                    <h4>æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»ä¸Šä¼ </h4>
                    <p>æ”¯æŒ: EXE, DLL, PDF, DOC, ZIPç­‰æ ¼å¼</p>
                    <p>æœ€å¤§æ–‡ä»¶å¤§å°: 100MB</p>
                </div>
                <input type="file" id="file-input" style="display: none;" onchange="uploadSample(this)">
                
                <h4>ğŸ§ª å¿«é€Ÿæµ‹è¯•æ ·æœ¬</h4>
                <button class="btn" onclick="generateSample('trojan')">ç”Ÿæˆæœ¨é©¬æ ·æœ¬</button>
                <button class="btn" onclick="generateSample('ransomware')">ç”Ÿæˆå‹’ç´¢è½¯ä»¶</button>
                <button class="btn" onclick="generateSample('banker')">ç”Ÿæˆé“¶è¡Œæœ¨é©¬</button>
            </div>
            
            <div class="panel">
                <h3>ğŸ” æ ·æœ¬åˆ†æé˜Ÿåˆ—</h3>
                <div id="sample-queue">
                    {% for sample in samples %}
                    <div class="sample-item threat-{{ sample.threat_level.lower() }}">
                        <strong>{{ sample.filename }}</strong>
                        <span style="float: right; color: #ff9800;">{{ sample.threat_level }}</span>
                        <br><div class="file-hash">MD5: {{ sample.md5_hash }}</div>
                        <div style="margin-top: 8px;">
                            <button class="btn btn-analyze" onclick="analyzeSample({{ sample.id }})">ğŸ”¬ åˆ†æ</button>
                            <button class="btn btn-download" onclick="downloadReport({{ sample.id }})">ğŸ“Š æŠ¥å‘Š</button>
                            <button class="btn btn-quarantine" onclick="quarantineSample({{ sample.id }})">ğŸ”’ éš”ç¦»</button>
                        </div>
                        {% if sample.analysis_status == 'analyzing' %}
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 60%"></div>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <div class="grid">
            <div class="panel">
                <h3>ğŸ§¬ åŠ¨æ€åˆ†æç»“æœ</h3>
                <div id="analysis-results">
                    <div class="analysis-result">
                        <strong>è¡Œä¸ºåˆ†æ:</strong><br>
                        âœ“ æ£€æµ‹åˆ°è¿›ç¨‹æ³¨å…¥è¡Œä¸º<br>
                        âœ“ å‘ç°ç½‘ç»œé€šä¿¡æ´»åŠ¨<br>
                        âœ“ æ£€æµ‹åˆ°æ³¨å†Œè¡¨ä¿®æ”¹<br>
                        âœ“ å‘ç°æ–‡ä»¶åŠ å¯†è¡Œä¸º<br>
                        âš ï¸ æ£€æµ‹åˆ°åè™šæ‹ŸæœºæŠ€æœ¯
                    </div>
                    
                    <h4>ğŸŒ ç½‘ç»œæ´»åŠ¨</h4>
                    <div class="network-graph">
                        <div class="ioc-item">DNSæŸ¥è¯¢: evil-c2.darkweb.com</div>
                        <div class="ioc-item">HTTP POST: 185.159.157.131:8080/gate.php</div>
                        <div class="ioc-item">TCPè¿æ¥: 91.219.29.81:443 (TLS)</div>
                        <div class="ioc-item">ä¸‹è½½æ–‡ä»¶: http://malicious.site/payload.exe</div>
                    </div>
                    
                    <h4>ğŸ·ï¸ æ£€æµ‹åˆ°çš„èƒ½åŠ›</h4>
                    <div>
                        <span class="capability-tag">æ–‡ä»¶åŠ å¯†</span>
                        <span class="capability-tag">è¿›ç¨‹æ³¨å…¥</span>
                        <span class="capability-tag">åè°ƒè¯•</span>
                        <span class="capability-tag">é”®ç›˜è®°å½•</span>
                        <span class="capability-tag">å±å¹•æˆªå›¾</span>
                        <span class="capability-tag">å‡­è¯çªƒå–</span>
                    </div>
                </div>
            </div>
            
            <div class="panel">
                <h3>ğŸ›¡ï¸ å¨èƒæƒ…æŠ¥</h3>
                <div class="analysis-result">
                    <strong>æ¶æ„è½¯ä»¶å®¶æ—:</strong> TrickBot<br>
                    <strong>å˜ç§:</strong> TrickBot.Variant.2024<br>
                    <strong>é¦–æ¬¡å‘ç°:</strong> 2024-01-15<br>
                    <strong>æ´»è·ƒçŠ¶æ€:</strong> é«˜æ´»è·ƒåº¦<br>
                    <strong>ç›®æ ‡:</strong> é‡‘èæœºæ„, ä¼ä¸šç½‘ç»œ
                </div>
                
                <h4>ğŸ¯ MITRE ATT&CK æ˜ å°„</h4>
                <div class="analysis-result">
                    T1055 - è¿›ç¨‹æ³¨å…¥<br>
                    T1071 - åº”ç”¨å±‚åè®®<br>
                    T1083 - æ–‡ä»¶å’Œç›®å½•å‘ç°<br>
                    T1105 - å…¥ä¾µå·¥å…·ä¼ è¾“<br>
                    T1486 - æ•°æ®åŠ å¯†å½±å“<br>
                    T1547 - å¯åŠ¨æˆ–ç™»å½•è‡ªå¯åŠ¨æ‰§è¡Œ
                </div>
                
                <h4>ğŸ” IOCs (å¨èƒæŒ‡æ ‡)</h4>
                <div>
                    <div class="ioc-item">MD5: a1b2c3d4e5f6789012345678901234567</div>
                    <div class="ioc-item">åŸŸå: evil-command.darknet.org</div>
                    <div class="ioc-item">IP: 91.219.29.81</div>
                    <div class="ioc-item">æ–‡ä»¶è·¯å¾„: %TEMP%\\svchost.exe</div>
                    <div class="ioc-item">æ³¨å†Œè¡¨: HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run</div>
                </div>
            </div>
        </div>
        
        <div class="panel full-width">
            <h3>ğŸ“Š å®æ—¶åˆ†æç›‘æ§</h3>
            <div style="height: 300px;">
                <canvas id="analysisChart" width="800" height="300"></canvas>
            </div>
        </div>
    </div>
    
    <script>
        function uploadSample(input) {
            const file = input.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('sample', file);
            
            fetch('/api/upload_sample', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('æ ·æœ¬ä¸Šä¼ æˆåŠŸ: ' + data.filename);
                    location.reload();
                } else {
                    alert('ä¸Šä¼ å¤±è´¥: ' + data.error);
                }
            })
            .catch(error => {
                alert('ä¸Šä¼ é”™è¯¯: ' + error);
            });
        }
        
        function generateSample(type) {
            fetch('/api/generate_sample', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: type })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('å·²ç”Ÿæˆæµ‹è¯•æ ·æœ¬: ' + data.filename);
                    location.reload();
                } else {
                    alert('ç”Ÿæˆå¤±è´¥: ' + data.error);
                }
            });
        }
        
        function analyzeSample(sampleId) {
            fetch('/api/analyze_sample', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ sample_id: sampleId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('å¼€å§‹åˆ†ææ ·æœ¬...');
                    // æ˜¾ç¤ºè¿›åº¦æ¡
                    updateAnalysisProgress(sampleId);
                } else {
                    alert('åˆ†æå¤±è´¥: ' + data.error);
                }
            });
        }
        
        function updateAnalysisProgress(sampleId) {
            // æ¨¡æ‹Ÿåˆ†æè¿›åº¦
            let progress = 0;
            const interval = setInterval(() => {
                progress += 10;
                if (progress <= 100) {
                    // æ›´æ–°è¿›åº¦æ¡
                    console.log('åˆ†æè¿›åº¦: ' + progress + '%');
                } else {
                    clearInterval(interval);
                    alert('åˆ†æå®Œæˆ!');
                    location.reload();
                }
            }, 1000);
        }
        
        function downloadReport(sampleId) {
            window.open('/api/download_report/' + sampleId, '_blank');
        }
        
        function quarantineSample(sampleId) {
            if (confirm('ç¡®å®šè¦éš”ç¦»æ­¤æ ·æœ¬å—ï¼Ÿéš”ç¦»åå°†æ— æ³•æ¢å¤ã€‚')) {
                fetch('/api/quarantine_sample', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sample_id: sampleId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('æ ·æœ¬å·²éš”ç¦»');
                        location.reload();
                    } else {
                        alert('éš”ç¦»å¤±è´¥: ' + data.error);
                    }
                });
            }
        }
        
        // å®šæ—¶æ›´æ–°ç»Ÿè®¡æ•°æ®
        setInterval(() => {
            fetch('/api/stats')
                .then(response => response.json())
                .then(data => {
                    document.querySelectorAll('.stat-value').forEach((elem, index) => {
                        const values = [data.total_samples, data.critical_threats, data.families_detected, data.analyzed_samples];
                        if (values[index] !== undefined) {
                            elem.textContent = values[index];
                        }
                    });
                });
        }, 10000);
    </script>
</body>
</html>
"""

@app.route('/')
def sandbox_dashboard():
    """æ¶æ„è½¯ä»¶åˆ†ææ²™ç®±ä¸»ç•Œé¢"""
    conn = sqlite3.connect('malware_analysis.db')
    cursor = conn.cursor()
    
    # è·å–æ ·æœ¬åˆ—è¡¨
    cursor.execute('''
        SELECT id, filename, md5_hash, threat_level, analysis_status, family 
        FROM malware_samples 
        ORDER BY submission_time DESC
    ''')
    
    samples = []
    for row in cursor.fetchall():
        samples.append({
            'id': row[0],
            'filename': row[1],
            'md5_hash': row[2][:16] + '...',
            'threat_level': row[3] or 'UNKNOWN',
            'analysis_status': row[4],
            'family': row[5] or 'Unknown'
        })
    
    # ç»Ÿè®¡æ•°æ®
    cursor.execute('SELECT COUNT(*) FROM malware_samples')
    total_samples = cursor.fetchone()[0]
    
    cursor.execute('SELECT COUNT(*) FROM malware_samples WHERE threat_level = "CRITICAL"')
    critical_threats = cursor.fetchone()[0]
    
    cursor.execute('SELECT COUNT(DISTINCT family) FROM malware_samples WHERE family IS NOT NULL')
    families_detected = cursor.fetchone()[0]
    
    cursor.execute('SELECT COUNT(*) FROM malware_samples WHERE analysis_status = "completed"')
    analyzed_samples = cursor.fetchone()[0]
    
    stats = {
        'total_samples': total_samples,
        'critical_threats': critical_threats,
        'families_detected': families_detected,
        'analyzed_samples': analyzed_samples
    }
    
    conn.close()
    
    return render_template_string(SANDBOX_TEMPLATE, samples=samples, stats=stats)

@app.route('/api/upload_sample', methods=['POST'])
def upload_sample():
    """ä¸Šä¼ æ¶æ„è½¯ä»¶æ ·æœ¬"""
    if 'sample' not in request.files:
        return jsonify({"success": False, "error": "æœªé€‰æ‹©æ–‡ä»¶"})
    
    file = request.files['sample']
    if file.filename == '':
        return jsonify({"success": False, "error": "æœªé€‰æ‹©æ–‡ä»¶"})
    
    # ä¿å­˜æ–‡ä»¶
    filename = file.filename
    file_path = os.path.join(sandbox.samples_dir, filename)
    file.save(file_path)
    
    # è®¡ç®—å“ˆå¸Œå€¼
    with open(file_path, 'rb') as f:
        file_content = f.read()
        md5_hash = hashlib.md5(file_content).hexdigest()
        sha1_hash = hashlib.sha1(file_content).hexdigest()
        sha256_hash = hashlib.sha256(file_content).hexdigest()
    
    # ä¿å­˜åˆ°æ•°æ®åº“
    conn = sqlite3.connect('malware_analysis.db')
    cursor = conn.cursor()
    
    cursor.execute('''
        INSERT INTO malware_samples (filename, md5_hash, sha1_hash, sha256_hash, file_size, submission_time)
        VALUES (?, ?, ?, ?, ?, ?)
    ''', (filename, md5_hash, sha1_hash, sha256_hash, len(file_content), datetime.now().isoformat()))
    
    conn.commit()
    conn.close()
    
    return jsonify({"success": True, "filename": filename, "md5": md5_hash})

@app.route('/api/generate_sample', methods=['POST'])
def generate_sample():
    """ç”Ÿæˆæµ‹è¯•æ¶æ„è½¯ä»¶æ ·æœ¬"""
    data = request.json
    sample_type = data.get('type', 'generic')
    
    # ç”Ÿæˆæ¨¡æ‹Ÿæ ·æœ¬
    sample_templates = {
        'trojan': {
            'filename': f'update_{random.randint(1000,9999)}.exe',
            'content': b'MZ' + b'TROJAN_SIMULATOR' + b'\x00' * 200,
            'family': 'GenericTrojan',
            'threat_level': 'HIGH'
        },
        'ransomware': {
            'filename': f'document_{random.randint(1000,9999)}.pdf.exe',
            'content': b'%PDF' + b'RANSOMWARE_SIMULATOR' + b'\x00' * 300,
            'family': 'CryptoLocker',
            'threat_level': 'CRITICAL'
        },
        'banker': {
            'filename': f'banking_app_{random.randint(1000,9999)}.exe',
            'content': b'MZ' + b'BANKER_SIMULATOR' + b'\x00' * 250,
            'family': 'BankingTrojan',
            'threat_level': 'HIGH'
        }
    }
    
    template = sample_templates.get(sample_type, sample_templates['trojan'])
    
    # ä¿å­˜æ ·æœ¬æ–‡ä»¶
    file_path = os.path.join(sandbox.samples_dir, template['filename'])
    with open(file_path, 'wb') as f:
        f.write(template['content'])
    
    # è®¡ç®—å“ˆå¸Œ
    md5_hash = hashlib.md5(template['content']).hexdigest()
    sha1_hash = hashlib.sha1(template['content']).hexdigest()
    sha256_hash = hashlib.sha256(template['content']).hexdigest()
    
    # ä¿å­˜åˆ°æ•°æ®åº“
    conn = sqlite3.connect('malware_analysis.db')
    cursor = conn.cursor()
    
    cursor.execute('''
        INSERT INTO malware_samples (filename, md5_hash, sha1_hash, sha256_hash, file_size, submission_time, threat_level, family)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?)
    ''', (template['filename'], md5_hash, sha1_hash, sha256_hash, 
          len(template['content']), datetime.now().isoformat(),
          template['threat_level'], template['family']))
    
    conn.commit()
    conn.close()
    
    return jsonify({"success": True, "filename": template['filename']})

@app.route('/api/analyze_sample', methods=['POST'])
def analyze_sample():
    """åˆ†ææ¶æ„è½¯ä»¶æ ·æœ¬"""
    data = request.json
    sample_id = data.get('sample_id')
    
    # æ¨¡æ‹Ÿåˆ†æè¿‡ç¨‹
    def simulate_analysis():
        time.sleep(2)  # æ¨¡æ‹Ÿåˆ†ææ—¶é—´
        
        conn = sqlite3.connect('malware_analysis.db')
        cursor = conn.cursor()
        
        # æ›´æ–°åˆ†æçŠ¶æ€
        cursor.execute('''
            UPDATE malware_samples 
            SET analysis_status = 'completed',
                capabilities = 'file_encryption,process_injection,anti_debug',
                network_behavior = 'c2_communication,data_exfiltration',
                file_operations = 'create_files,modify_registry',
                process_operations = 'inject_explorer,create_service'
            WHERE id = ?
        ''', (sample_id,))
        
        # æ·»åŠ åŠ¨æ€åˆ†æç»“æœ
        cursor.execute('''
            INSERT INTO dynamic_analysis (
                sample_id, execution_time, cpu_usage, memory_usage,
                network_connections, dns_queries, file_modifications
            ) VALUES (?, ?, ?, ?, ?, ?, ?)
        ''', (sample_id, 120, 45.5, 128.0,
              'tcp:91.219.29.81:443,tcp:185.159.157.131:8080',
              'evil-c2.darkweb.com,malicious.site',
              '%TEMP%\\svchost.exe,%APPDATA%\\update.dat'))
        
        conn.commit()
        conn.close()
    
    # åœ¨åå°çº¿ç¨‹ä¸­è¿è¡Œåˆ†æ
    analysis_thread = threading.Thread(target=simulate_analysis)
    analysis_thread.start()
    
    # ç«‹å³æ›´æ–°çŠ¶æ€ä¸ºæ­£åœ¨åˆ†æ
    conn = sqlite3.connect('malware_analysis.db')
    cursor = conn.cursor()
    cursor.execute('UPDATE malware_samples SET analysis_status = "analyzing" WHERE id = ?', (sample_id,))
    conn.commit()
    conn.close()
    
    return jsonify({"success": True, "message": "åˆ†æå·²å¼€å§‹"})

@app.route('/api/download_report/<int:sample_id>')
def download_report(sample_id):
    """ä¸‹è½½åˆ†ææŠ¥å‘Š"""
    conn = sqlite3.connect('malware_analysis.db')
    cursor = conn.cursor()
    
    # è·å–æ ·æœ¬ä¿¡æ¯
    cursor.execute('SELECT * FROM malware_samples WHERE id = ?', (sample_id,))
    sample = cursor.fetchone()
    
    # è·å–åŠ¨æ€åˆ†æç»“æœ
    cursor.execute('SELECT * FROM dynamic_analysis WHERE sample_id = ?', (sample_id,))
    analysis = cursor.fetchone()
    
    conn.close()
    
    if not sample:
        return "æ ·æœ¬ä¸å­˜åœ¨", 404
    
    # ç”ŸæˆJSONæŠ¥å‘Š
    report = {
        "sample_info": {
            "filename": sample[1],
            "md5": sample[2],
            "sha1": sample[3],
            "sha256": sample[4],
            "file_size": sample[5],
            "submission_time": sample[7],
            "threat_level": sample[9] or "UNKNOWN"
        },
        "static_analysis": {
            "file_type": sample[6] or "PE32",
            "family": sample[10] or "Unknown",
            "capabilities": sample[11] or "",
            "threat_score": random.randint(70, 95)
        },
        "dynamic_analysis": {
            "execution_time": analysis[2] if analysis else 0,
            "cpu_usage": analysis[3] if analysis else 0,
            "memory_usage": analysis[4] if analysis else 0,
            "network_connections": analysis[5] if analysis else "",
            "dns_queries": analysis[6] if analysis else "",
            "file_modifications": analysis[7] if analysis else ""
        },
        "mitre_attack": [
            "T1055 - Process Injection",
            "T1071 - Application Layer Protocol", 
            "T1486 - Data Encrypted for Impact"
        ],
        "iocs": [
            {"type": "md5", "value": sample[2]},
            {"type": "domain", "value": "evil-c2.darkweb.com"},
            {"type": "ip", "value": "91.219.29.81"}
        ]
    }
    
    # ä¿å­˜æŠ¥å‘Šæ–‡ä»¶
    report_path = os.path.join(sandbox.reports_dir, f"report_{sample_id}.json")
    with open(report_path, 'w', encoding='utf-8') as f:
        json.dump(report, f, indent=2, ensure_ascii=False)
    
    return send_file(report_path, as_attachment=True, download_name=f"malware_report_{sample_id}.json")

@app.route('/api/quarantine_sample', methods=['POST'])
def quarantine_sample():
    """éš”ç¦»æ¶æ„è½¯ä»¶æ ·æœ¬"""
    data = request.json
    sample_id = data.get('sample_id')
    
    conn = sqlite3.connect('malware_analysis.db')
    cursor = conn.cursor()
    
    # è·å–æ ·æœ¬ä¿¡æ¯
    cursor.execute('SELECT filename FROM malware_samples WHERE id = ?', (sample_id,))
    result = cursor.fetchone()
    
    if result:
        filename = result[0]
        
        # ç§»åŠ¨æ–‡ä»¶åˆ°éš”ç¦»åŒº
        source_path = os.path.join(sandbox.samples_dir, filename)
        quarantine_path = os.path.join(sandbox.quarantine_dir, f"quarantined_{sample_id}_{filename}")
        
        if os.path.exists(source_path):
            shutil.move(source_path, quarantine_path)
        
        # æ›´æ–°æ•°æ®åº“çŠ¶æ€
        cursor.execute('UPDATE malware_samples SET analysis_status = "quarantined" WHERE id = ?', (sample_id,))
        conn.commit()
        conn.close()
        
        return jsonify({"success": True, "message": "æ ·æœ¬å·²éš”ç¦»"})
    
    conn.close()
    return jsonify({"success": False, "error": "æ ·æœ¬ä¸å­˜åœ¨"})

@app.route('/api/stats')
def get_stats():
    """è·å–ç»Ÿè®¡æ•°æ®"""
    conn = sqlite3.connect('malware_analysis.db')
    cursor = conn.cursor()
    
    cursor.execute('SELECT COUNT(*) FROM malware_samples')
    total_samples = cursor.fetchone()[0]
    
    cursor.execute('SELECT COUNT(*) FROM malware_samples WHERE threat_level = "CRITICAL"')
    critical_threats = cursor.fetchone()[0]
    
    cursor.execute('SELECT COUNT(DISTINCT family) FROM malware_samples WHERE family IS NOT NULL')
    families_detected = cursor.fetchone()[0]
    
    cursor.execute('SELECT COUNT(*) FROM malware_samples WHERE analysis_status = "completed"')
    analyzed_samples = cursor.fetchone()[0]
    
    conn.close()
    
    return jsonify({
        "total_samples": total_samples,
        "critical_threats": critical_threats,
        "families_detected": families_detected,
        "analyzed_samples": analyzed_samples
    })

if __name__ == '__main__':
    print("ğŸ¦  å¯åŠ¨æ¶æ„è½¯ä»¶åˆ†ææ²™ç®±...")
    print("è®¿é—® http://localhost:5005 å¼€å§‹æ¶æ„è½¯ä»¶åˆ†æ")
    print("")
    print("ğŸ”¬ æ”¯æŒåŠŸèƒ½:")
    print("  - æ ·æœ¬ä¸Šä¼ å’Œç®¡ç†")
    print("  - åŠ¨æ€è¡Œä¸ºåˆ†æ")
    print("  - å¨èƒæƒ…æŠ¥é›†æˆ")
    print("  - MITRE ATT&CKæ˜ å°„")
    print("  - è‡ªåŠ¨åŒ–æŠ¥å‘Šç”Ÿæˆ")
    print("  - æ ·æœ¬éš”ç¦»ç®¡ç†")
    
    app.run(host='0.0.0.0', port=5005, debug=True)
