{% extends "base.html" %}

{% block title %}仿真控制台 - 银狐木马攻击仿真复现实验{% endblock %}

{% block content %}
<!-- 仿真状态概览 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-tachometer-alt me-2"></i>仿真控制台
                </h5>
                <div>
                    <button class="btn btn-sm btn-success me-2" onclick="startSimulation(true)">
                        <i class="fas fa-vial me-1"></i>测试模式
                    </button>
                    <button class="btn btn-sm btn-primary me-2" onclick="startSimulation(false)">
                        <i class="fas fa-play me-1"></i>完整仿真
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="stopSimulation()">
                        <i class="fas fa-stop me-1"></i>停止
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value" id="stages-completed">{{ status.stages_completed }}</div>
                            <div class="metric-label">已完成阶段</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value" id="total-stages">{{ status.total_stages }}</div>
                            <div class="metric-label">总阶段数</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value">
                                <span class="status-indicator" id="simulation-status-indicator"></span>
                                <span id="simulation-status-text">{{ "运行中" if status.running else "已停止" }}</span>
                            </div>
                            <div class="metric-label">仿真状态</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value" id="error-count">{{ status.errors|length }}</div>
                            <div class="metric-label">错误数量</div>
                        </div>
                    </div>
                </div>
                
                <!-- 进度条 -->
                <div class="mt-4">
                    <div class="d-flex justify-content-between mb-2">
                        <span>总体进度</span>
                        <span id="progress-text">{{ "%.0f"|format((status.stages_completed / status.total_stages * 100) if status.total_stages > 0 else 0) }}%</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar simulation-progress" role="progressbar" 
                             id="overall-progress" 
                             style="width: {{ (status.stages_completed / status.total_stages * 100) if status.total_stages > 0 else 0 }}%">
                        </div>
                    </div>
                </div>
                
                <!-- 当前阶段 -->
                {% if status.current_stage %}
                <div class="mt-3">
                    <strong>当前阶段:</strong> 
                    <span id="current-stage" class="badge bg-primary">{{ status.current_stage }}</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 攻击链阶段详情 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-sitemap me-2"></i>攻击链阶段详情
                </h5>
            </div>
            <div class="card-body">
                <div class="row" id="attack-stages">
                    <!-- 动态填充攻击阶段 -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 实时日志和结果 -->
<div class="row">
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-file-alt me-2"></i>实时日志
                </h5>
                <button class="btn btn-sm btn-outline-primary" onclick="clearLogs()">
                    <i class="fas fa-trash me-1"></i>清空
                </button>
            </div>
            <div class="card-body p-0">
                <div class="log-container" id="log-container">
                    <div id="log-content">
                        {% for log in status.logs %}
                        <div class="log-entry">
                            <span class="text-info">[{{ log.timestamp }}]</span>
                            <span class="text-{{ 'success' if log.level == 'SUCCESS' else 'danger' if log.level == 'ERROR' else 'warning' }}">{{ log.level }}</span>
                            <span>{{ log.message }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar me-2"></i>实时结果
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6 mb-3">
                        <div class="text-center">
                            <div class="metric-value text-success" id="success-rate">{{ results.attack_success_rate }}%</div>
                            <div class="metric-label">攻击成功率</div>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="text-center">
                            <div class="metric-value text-danger" id="compromised-targets">{{ results.targets_compromised }}</div>
                            <div class="metric-label">被入侵目标</div>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="text-center">
                            <div class="metric-value text-warning" id="exfiltrated-data">{{ results.data_exfiltrated }}</div>
                            <div class="metric-label">数据泄露次数</div>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="text-center">
                            <div class="metric-value text-info" id="evasion-rate">{{ results.detection_evasion_rate }}%</div>
                            <div class="metric-label">检测规避率</div>
                        </div>
                    </div>
                </div>
                
                <!-- 结果图表 -->
                <div class="mt-3">
                    <canvas id="results-chart" height="200"></canvas>
                </div>
                
                <!-- 操作按钮 -->
                <div class="d-grid gap-2 mt-3">
                    <button class="btn btn-outline-primary" onclick="generateReport()">
                        <i class="fas fa-file-pdf me-2"></i>生成报告
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 错误信息模态框 -->
<div class="modal fade" id="errorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>仿真错误
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="error-list">
                    {% for error in status.errors %}
                    <div class="alert alert-warning">{{ error }}</div>
                    {% endfor %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let statusUpdateInterval;
    let resultsChart;
    
    // 页面加载时初始化
    document.addEventListener('DOMContentLoaded', function() {
        initializeChart();
        startStatusUpdates();
        updateStageCards();
    });
    
    // 初始化结果图表
    function initializeChart() {
        const ctx = document.getElementById('results-chart').getContext('2d');
        resultsChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['攻击成功率', '检测规避率', '剩余'],
                datasets: [{
                    data: [{{ results.attack_success_rate }}, {{ results.detection_evasion_rate }}, 100 - Math.max({{ results.attack_success_rate }}, {{ results.detection_evasion_rate }})],
                    backgroundColor: ['#28a745', '#17a2b8', '#e9ecef'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            boxWidth: 12,
                            font: {
                                size: 10
                            }
                        }
                    }
                }
            }
        });
    }
    
    // 开始状态更新
    function startStatusUpdates() {
        statusUpdateInterval = setInterval(updateStatus, 2000);
    }
    
    // 停止状态更新
    function stopStatusUpdates() {
        if (statusUpdateInterval) {
            clearInterval(statusUpdateInterval);
        }
    }
    
    // 更新状态
    async function updateStatus() {
        const data = await apiCall('/api/status');
        if (data) {
            updateStatusDisplay(data.status);
            updateResultsDisplay(data.results);
        }
    }
    
    // 更新状态显示
    function updateStatusDisplay(status) {
        document.getElementById('stages-completed').textContent = status.stages_completed;
        document.getElementById('total-stages').textContent = status.total_stages;
        document.getElementById('error-count').textContent = status.errors.length;
        
        const progress = status.total_stages > 0 ? (status.stages_completed / status.total_stages * 100) : 0;
        document.getElementById('progress-text').textContent = Math.round(progress) + '%';
        document.getElementById('overall-progress').style.width = progress + '%';
        
        // 更新状态指示器
        const indicator = document.getElementById('simulation-status-indicator');
        const statusText = document.getElementById('simulation-status-text');
        
        if (status.running) {
            indicator.className = 'status-indicator status-running pulse-animation';
            statusText.textContent = '运行中';
        } else {
            indicator.className = 'status-indicator status-stopped';
            statusText.textContent = '已停止';
        }
        
        // 更新当前阶段
        const currentStageElement = document.getElementById('current-stage');
        if (currentStageElement && status.current_stage) {
            currentStageElement.textContent = status.current_stage;
        }
        
        // 更新日志
        updateLogs(status.logs);
        
        // 显示错误
        if (status.errors.length > 0) {
            updateErrorModal(status.errors);
        }
    }
    
    // 更新结果显示
    function updateResultsDisplay(results) {
        document.getElementById('success-rate').textContent = results.attack_success_rate + '%';
        document.getElementById('compromised-targets').textContent = results.targets_compromised;
        document.getElementById('exfiltrated-data').textContent = results.data_exfiltrated;
        document.getElementById('evasion-rate').textContent = results.detection_evasion_rate + '%';
        
        // 更新图表
        if (resultsChart) {
            resultsChart.data.datasets[0].data = [
                results.attack_success_rate,
                results.detection_evasion_rate,
                100 - Math.max(results.attack_success_rate, results.detection_evasion_rate)
            ];
            resultsChart.update();
        }
    }
    
    // 更新日志
    function updateLogs(logs) {
        const logContent = document.getElementById('log-content');
        let html = '';
        
        logs.slice(-20).forEach(log => {
            const levelClass = log.level === 'SUCCESS' ? 'success' : 
                              log.level === 'ERROR' ? 'danger' : 'warning';
            html += `
                <div class="log-entry">
                    <span class="text-info">[${log.timestamp}]</span>
                    <span class="text-${levelClass}">${log.level}</span>
                    <span>${log.message}</span>
                </div>
            `;
        });
        
        logContent.innerHTML = html;
        logContent.scrollTop = logContent.scrollHeight;
    }
    
    // 更新错误模态框
    function updateErrorModal(errors) {
        const errorList = document.getElementById('error-list');
        let html = '';
        
        errors.forEach(error => {
            html += `<div class="alert alert-warning">${error}</div>`;
        });
        
        errorList.innerHTML = html;
    }
    
    // 更新阶段卡片
    function updateStageCards() {
        const stages = [
            { name: '初始访问', icon: 'envelope', color: 'primary' },
            { name: '代码执行', icon: 'cogs', color: 'success' },
            { name: '内网侦察', icon: 'search', color: 'info' },
            { name: '攻击规划', icon: 'route', color: 'warning' },
            { name: '横向移动', icon: 'arrows-alt', color: 'danger' },
            { name: '数据窃取', icon: 'download', color: 'dark' }
        ];
        
        const container = document.getElementById('attack-stages');
        let html = '';
        
        stages.forEach((stage, index) => {
            html += `
                <div class="col-md-2 mb-3">
                    <div class="card border-${stage.color} h-100">
                        <div class="card-body text-center p-2">
                            <i class="fas fa-${stage.icon} fa-2x text-${stage.color} mb-2"></i>
                            <h6 class="card-title mb-1">${stage.name}</h6>
                            <div class="stage-status" id="stage-${index}">
                                <span class="badge bg-secondary">待执行</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    // 仿真控制函数
    async function startSimulation(testMode) {
        const result = await apiCall('/api/start_simulation', 'POST', { test_mode: testMode });
        if (result && result.success) {
            showToast(testMode ? '测试模式已启动' : '完整仿真已启动', 'success');
        } else {
            showToast(result ? result.message : '启动失败', 'danger');
        }
    }
    
    async function stopSimulation() {
        const result = await apiCall('/api/stop_simulation', 'POST');
        if (result && result.success) {
            showToast('仿真已停止', 'info');
        } else {
            showToast(result ? result.message : '停止失败', 'danger');
        }
    }
    
    async function generateReport() {
        const result = await apiCall('/api/generate_report', 'POST');
        if (result && result.success) {
            showToast('报告生成成功', 'success');
        } else {
            showToast(result ? result.message : '报告生成失败', 'danger');
        }
    }
    
    function clearLogs() {
        document.getElementById('log-content').innerHTML = '';
        showToast('日志已清空', 'info');
    }
    
    // 页面卸载时清理
    window.addEventListener('beforeunload', function() {
        stopStatusUpdates();
    });
</script>
{% endblock %}